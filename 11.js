const paddingRatio=.25,SPECIAL_PETAL_TYPES={byType:["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"],minRarity:null,byPrefix:[],bySuffix:[],customFilter:null};function isSpecialPetal(t){const e=t.type,a=t.rarity;if(SPECIAL_PETAL_TYPES.byType.includes(e))return!0;if(null!==SPECIAL_PETAL_TYPES.minRarity&&a>=SPECIAL_PETAL_TYPES.minRarity)return!0;for(const t of SPECIAL_PETAL_TYPES.byPrefix)if(e.startsWith(t))return!0;for(const t of SPECIAL_PETAL_TYPES.bySuffix)if(e.endsWith(t))return!0;return!(!SPECIAL_PETAL_TYPES.customFilter||"function"!=typeof SPECIAL_PETAL_TYPES.customFilter||!SPECIAL_PETAL_TYPES.customFilter(t))}let savedPetals=localStorage.getItem("savedPetals");try{savedPetals=JSON.parse(savedPetals)}catch(t){savedPetals=!1}class Inventory{constructor(t){this.topPetalSlots=[],this.bottomPetalSlots=[];for(let e=0;e<t;e++)this.topPetalSlots.push(new PetalSlot({x:0,y:0,size:65})),this.bottomPetalSlots.push(new PetalSlot({x:0,y:0,size:55}));this.artifactSlot={x:0,y:0,size:65},this.positionPetalSlots(),this.topPetalContainers={},this.bottomPetalContainers={},this.artifactContainer=null,this.translateY=0,this.speedCircle={reload:1,mode:0,targetReload:1},void 0!==localStorage.getItem("speedCircle")&&null!==localStorage.getItem("speedCircle")&&(this.speedCircle.reload=Number(localStorage.getItem("speedCircle")),isNaN(this.speedCircle.reload)&&(this.speedCircle.reload=1));try{if(savedPetals){for(let t in savedPetals.top){const e=savedPetals.top[t];this.addPetalContainer(new PetalContainer(e.petals.map(t=>new Petal(t)),{...e},Math.random(),1),!0,t),e.render.x=canvas.w,e.render.y=2*canvas.h/3}for(let t in savedPetals.bottom){const e=savedPetals.bottom[t];this.addPetalContainer(new PetalContainer(e.petals.map(t=>new Petal(t)),{...e},Math.random(),1),!1,t),e.render.x=canvas.w,e.render.y=2*canvas.h/3}}}catch(t){localStorage.removeItem("savedPetals")}this.fadingPetalContainer=null}initChangePetalsQueue(){this===menuInventory&&(this.changePetalsQueueInterval=setInterval(()=>{void 0!==this.queuedChangedPetals&&"menu"===window.state&&!0===window.connected&&(send({changePetals:!0,...this.queuedChangedPetals}),delete this.queuedChangedPetals)},1200))}sendQueuedChangedPetalsImmediately(){send({changePetals:!0,...this.pack()})}setPetalSlotsNumber(t){localStorage.setItem("savedSlotAmount",t);for(let e=this.topPetalSlots.length;e<t;e++)this.topPetalSlots.push(new PetalSlot({x:0,y:0,size:65})),this.bottomPetalSlots.push(new PetalSlot({x:0,y:0,size:55}));for(let e in this.bottomPetalContainers)e>t-1&&delete this.bottomPetalContainers[e];for(let e in this.topPetalContainers)e>t-1&&delete this.topPetalContainers[e];this.positionPetalSlots()}copy(t){this.topPetalContainers=t.topPetalContainers,this.bottomPetalContainers=t.bottomPetalContainers,this.speedCircle=structuredClone(t.speedCircle),this.speedCircle.targetReload=this.speedCircle.reload}positionPetalSlots(){const t=this.topPetalSlots[0].size,e=this.bottomPetalSlots[0].size,a=this.topPetalSlots.length*t+.25*(this.topPetalSlots.length-1)*t;for(let i=0;i<this.topPetalSlots.length;i++)this.topPetalSlots[i].x=canvas.w/2-(a-t)/2+i*(t+.25*t),this.topPetalSlots[i].y=canvas.h-e-.25*e-.25*t-t/2;const i=this.bottomPetalSlots.length*e+.25*(this.bottomPetalSlots.length-1)*e;for(let t=0;t<this.bottomPetalSlots.length;t++)this.bottomPetalSlots[t].x=canvas.w/2-(i-e)/2+t*(e+.25*e),this.bottomPetalSlots[t].y=canvas.h-.25*e-e/2;for(let t in this.topPetalContainers){const e=this.topPetalSlots[t];void 0!==e&&(this.topPetalContainers[t].x=e.x,this.topPetalContainers[t].y=e.y,this.topPetalContainers[t].w=e.size,this.topPetalContainers[t].h=e.size)}for(let t in this.bottomPetalContainers){const e=this.bottomPetalSlots[t];void 0!==e&&(this.bottomPetalContainers[t].x=e.x,this.bottomPetalContainers[t].y=e.y,this.bottomPetalContainers[t].w=e.size,this.bottomPetalContainers[t].h=e.size)}const n=this.topPetalSlots[this.topPetalSlots.length-1];this.artifactSlot.x=n.x+n.size+20,this.artifactSlot.y=n.y,this.artifactContainer&&(this.artifactContainer.x=this.artifactSlot.x,this.artifactContainer.y=this.artifactSlot.y,this.artifactContainer.w=this.artifactSlot.size,this.artifactContainer.h=this.artifactSlot.size)}addPetalContainer(t,e,a,i=!0){if(e){if(void 0!==this.topPetalContainers[a]&&(this.topPetalContainers[a].w=65,this.topPetalContainers[a].h=65,this.topPetalContainers[a].render.y+=this.translateY,i)){const t=this.topPetalContainers[a];this.fadingPetalContainer=t,this.fadingPetalContainer.fadeTime=time,isSpecialPetal(t)?specialGlobalInventory.addPetalContainer(t):globalInventory.addPetalContainer(t)}this.topPetalContainers[a]=t}else{if(void 0!==this.bottomPetalContainers[a]&&(this.bottomPetalContainers[a].w=65,this.bottomPetalContainers[a].h=65,this.bottomPetalContainers[a].render.y+=this.translateY,i)){const t=this.bottomPetalContainers[a];this.fadingPetalContainer=t,this.fadingPetalContainer.fadeTime=time,isSpecialPetal(t)?specialGlobalInventory.addPetalContainer(t):globalInventory.addPetalContainer(t)}this.bottomPetalContainers[a]=t}this.positionPetalSlots(),t.render.y-=this.translateY,this.updateSavedPetals()}addInFirstAvailableSlot(t){const e=t.petals?.[0]?.type||t.type;if(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"].includes(e))return!1;for(let e=0;e<this.topPetalSlots.length;e++)if(void 0===this.topPetalContainers[e])return this.addPetalContainer(t,!0,e,!0),!0;for(let e=0;e<this.bottomPetalSlots.length;e++)if(void 0===this.bottomPetalContainers[e])return this.addPetalContainer(t,!1,e,!0),!0;return!1}getClosest(t){const e={x:t.x,y:t.y,difference:{x:t.w/2,y:t.h/2}};for(let a=0;a<this.topPetalSlots.length;a++){if(void 0!==t.lastPetalSlot&&!0===t.lastPetalSlot.top&&t.lastPetalSlot.index==a)continue;const i=this.topPetalSlots[a],n={x:i.x,y:i.y+this.translateY,difference:{x:i.size,y:i.size}};if(!0===this.intersectingRect(e,n))return i}for(let a=0;a<this.bottomPetalSlots.length;a++){if(void 0!==t.lastPetalSlot&&!1===t.lastPetalSlot.top&&t.lastPetalSlot.index==a)continue;const i=this.bottomPetalSlots[a],n={x:i.x,y:i.y+this.translateY,difference:{x:i.size,y:i.size}};if(!0===this.intersectingRect(e,n))return i}return!1}addClosest(t,e){const a={x:t.x,y:t.y,difference:{x:t.w/2,y:t.h/2}},i=t.petals?.[0]?.type||t.type;if(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"].includes(i)){const e=this.artifactSlot,n={x:e.x,y:e.y+this.translateY,difference:{x:e.size,y:e.size}};if(!0===this.intersectingRect(a,n)){if(this.artifactContainer&&this.artifactContainer!==t){const t=this.artifactContainer;t.render.y+=this.translateY,t.w=65,t.h=65,"undefined"!=typeof specialGlobalInventory&&(specialGlobalInventory.addPetalContainer(t),specialGlobalInventory.equippedArtifact=null)}return this.artifactContainer=t,this.artifactContainer.x=e.x,this.artifactContainer.y=e.y,this.artifactContainer.w=e.size,this.artifactContainer.h=e.size,this.artifactContainer.render.y-=this.translateY,"undefined"!=typeof specialGlobalInventory&&specialGlobalInventory.equipArtifact(i),!0}return"undefined"!=typeof specialGlobalInventory&&specialGlobalInventory.addPetalContainer(t),!0}for(let e=0;e<this.topPetalSlots.length;e++){const i=this.topPetalSlots[e],n={x:i.x,y:i.y+this.translateY,difference:{x:i.size,y:i.size}};if(!0===this.intersectingRect(a,n)){if(void 0!==t.lastPetalSlot&&-1!==t.lastPetalSlot.index){let a=this.topPetalContainers[e];return void 0===a?(this.addPetalContainer(t,!0,e),!0):(this.addPetalContainer(t,!0,e,!1),this.addPetalContainer(a,t.lastPetalSlot.top,t.lastPetalSlot.index,!1),!0)}return this.addPetalContainer(t,!0,e),!0}}for(let e=0;e<this.bottomPetalSlots.length;e++){const i=this.bottomPetalSlots[e],n={x:i.x,y:i.y+this.translateY,difference:{x:i.size,y:i.size}};if(!0===this.intersectingRect(a,n)){if(void 0!==t.lastPetalSlot&&-1!==t.lastPetalSlot.index){let a=this.bottomPetalContainers[e];return void 0===a?(this.addPetalContainer(t,!1,e),!0):(this.addPetalContainer(t,!1,e,!1),this.addPetalContainer(a,t.lastPetalSlot.top,t.lastPetalSlot.index,!1),!0)}return this.addPetalContainer(t,!1,e),!0}}return!1}intersectingRect(t,e){return!(t.x-t.difference.x/2>e.x+e.difference.x/2||t.x+t.difference.x/2<e.x-e.difference.x/2||t.y-t.difference.y/2>e.y+e.difference.y/2||t.y+t.difference.y/2<e.y-e.difference.y/2)}removePetalContainer(t,e){!0===t?this.bottomPetalContainers[e].amount>1?(this.bottomPetalContainers[e].amount--,this.bottomPetalContainers[e].y-=this.translateY,this.bottomPetalContainers[e].w=50,this.bottomPetalContainers[e].h=50):delete this.bottomPetalContainers[e]:this.topPetalContainers[e].amount>1?(this.topPetalContainers[e].amount--,this.topPetalContainers[e].y-=this.translateY,this.topPetalContainers[e].w=50,this.topPetalContainers[e].h=50):delete this.topPetalContainers[e],this.updateSavedPetals()}clear(){this.topPetalContainers={},this.bottomPetalContainers={}}mouseDown({mouseX:t,mouseY:e},a){if("menu"!==window.state){if("game"==window.state){for(let a in this.topPetalContainers){const i=this.topPetalContainers[a];if(t>i.x-i.w/2&&t<i.x+i.w/2&&e>i.y-i.h/2&&e<i.y+i.h/2)return void this.swapPetals(parseInt(a))}for(let a in this.bottomPetalContainers){const i=this.bottomPetalContainers[a];if(t>i.x-i.w/2&&t<i.x+i.w/2&&e>i.y-i.h/2&&e<i.y+i.h/2)return void this.swapPetals(parseInt(a))}}return}const i=e-this.translateY;for(let e in this.topPetalContainers){const a=this.topPetalContainers[e];if(t>a.x-a.w/2&&t<a.x+a.w/2&&i>a.y-a.h/2&&i<a.y+a.h/2)return draggingPetalContainer=new PetalContainer(a.petals,{...a,isDragging:!0,lastSlot:{top:!0,index:e}},Math.random(),1),draggingPetalContainer.mouseOffset={x:draggingPetalContainer.x-t,y:draggingPetalContainer.y-i},draggingPetalContainer.render.y+=this.translateY,draggingPetalContainer.y+=this.translateY,draggingPetalContainer.w=85,draggingPetalContainer.h=85,draggingPetalContainer.spawnAnimation=1,void this.removePetalContainer(!1,e)}for(let e in this.bottomPetalContainers){const a=this.bottomPetalContainers[e];if(t>a.x-a.w/2&&t<a.x+a.w/2&&i>a.y-a.h/2&&i<a.y+a.h/2)return draggingPetalContainer=new PetalContainer(a.petals,{...a,isDragging:!0,lastSlot:{top:!1,index:e}},Math.random(),1),draggingPetalContainer.mouseOffset={x:draggingPetalContainer.x-t,y:draggingPetalContainer.y-i},draggingPetalContainer.render.y+=this.translateY,draggingPetalContainer.y+=this.translateY,draggingPetalContainer.w=85,draggingPetalContainer.h=85,draggingPetalContainer.spawnAnimation=1,void this.removePetalContainer(!0,e)}const n=this.artifactSlot;if(t>n.x-n.size/2&&t<n.x+n.size/2&&i>n.y-n.size/2&&i<n.y+n.size/2&&this.artifactContainer&&this.artifactContainer.amount>0){if("game"===window.state&&window.connected){const t=this.artifactContainer.type;return void(t&&send({activateArtifactUltimate:{artifactType:t}}))}if(draggingPetalContainer=new PetalContainer(this.artifactContainer.petals,{...this.artifactContainer,isDragging:!0,lastSlot:{artifact:!0}},Math.random(),1),"undefined"!=typeof specialGlobalInventory&&specialGlobalInventory.equippedArtifact){const t=specialGlobalInventory.artifacts[specialGlobalInventory.equippedArtifact];if(t&&t.skillLevels){const e=Object.values(t.skillLevels).reduce((t,e)=>t+e,0)-1;e>0&&(draggingPetalContainer.rarity=e)}}draggingPetalContainer.mouseOffset={x:draggingPetalContainer.x-t,y:draggingPetalContainer.y-i},draggingPetalContainer.render.y+=this.translateY,draggingPetalContainer.y+=this.translateY,draggingPetalContainer.w=85,draggingPetalContainer.h=85,draggingPetalContainer.spawnAnimation=1,this.artifactContainer=null,"undefined"!=typeof specialGlobalInventory&&(specialGlobalInventory.equippedArtifact=null)}}swapPetals(t,e=!0){if(window.reconnecting)return;if(void 0===this.topPetalSlots[t])return;const a=this.topPetalContainers[t];this.topPetalContainers[t]=this.bottomPetalContainers[t],this.bottomPetalContainers[t]=a,void 0===this.topPetalContainers[t]&&delete this.topPetalContainers[t],void 0===this.bottomPetalContainers[t]&&delete this.bottomPetalContainers[t],this.positionPetalSlots(),!0===e&&send({swapPetal:t}),this.updateSavedPetals()}draw(t=1){if(ctx.translate(0,this.translateY),null!==this.fadingPetalContainer){const e={x:this.fadingPetalContainer.render.x,y:this.fadingPetalContainer.render.y};this.fadingPetalContainer.render.x=this.fadingPetalContainer.x,this.fadingPetalContainer.render.y=this.fadingPetalContainer.y;const a=1-(time-this.fadingPetalContainer.fadeTime)/200;ctx.globalAlpha=Math.max(0,Math.min(1,a)),ctx.save(),ctx.translate(this.fadingPetalContainer.x,this.fadingPetalContainer.y),ctx.scale(2-a,2-a),ctx.translate(-this.fadingPetalContainer.x,-this.fadingPetalContainer.y),this.fadingPetalContainer.draw(t),ctx.restore(),this.fadingPetalContainer.render.x=e.x,this.fadingPetalContainer.render.y=e.y,time-this.fadingPetalContainer.fadeTime>200&&(this.fadingPetalContainer=null)}for(let e=0;e<this.topPetalSlots.length;e++)this.topPetalSlots[e].draw(t);for(let e=0;e<this.bottomPetalSlots.length;e++)this.bottomPetalSlots[e].draw(t);for(let t in this.topPetalContainers)this.topPetalContainers[t].draw(!0,t);for(let t in this.bottomPetalContainers)this.bottomPetalContainers[t].draw();this.drawArtifactSlot(),this.speedCircle.reload>1&&(this.speedCircle.reload=1),this.speedCircle.reload<0&&(this.speedCircle.reload=0),2===this.speedCircle.mode&&(this.speedCircle.reload+=.001*dt),1===this.speedCircle.mode&&(this.speedCircle.reload-=.001*dt),"game"==window.state&&(this.speedCircle.reload=interpolate(this.speedCircle.targetReload,this.speedCircle.reload,.4));let e=this.bottomPetalSlots[this.bottomPetalSlots.length-1];ctx.translate(e.x+e.size+35,e.y),ctx.globalAlpha*=.5,ctx.fillStyle="#000000",ctx.strokeStyle="#ffffff",ctx.beginPath(),ctx.arc(0,0,e.size/2.1875,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.save(),ctx.beginPath(),ctx.arc(0,0,e.size/2.5,0,2*Math.PI),ctx.closePath(),ctx.clip(),ctx.lineCap="butt";let a=(1-Math.pow(this.speedCircle.reload,.7))*Math.PI*2;ctx.lineWidth=50,ctx.beginPath(),ctx.arc(0,0,25,a-2*Math.PI*smoothstep(this.speedCircle.reload),a),ctx.stroke(),ctx.closePath(),ctx.restore(),ctx.globalAlpha/=.5,ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.font="900 12.5px Ubuntu",ctx.textAlign="center",ctx.textBaseline="middle",ctx.lineWidth=2,ctx.strokeText("[Q]",-e.size/2.5-17.5,0),ctx.fillText("[Q]",-e.size/2.5-17.5,0),ctx.strokeText("[E]",e.size/2.5+17.5,0),ctx.fillText("[E]",e.size/2.5+17.5,0),ctx.strokeText("Speed",0,0),ctx.fillText("Speed",0,0),ctx.translate(-(e.x+e.size+35),-e.y),ctx.translate(0,-this.translateY);const i=mouse.x*canvas.w/window.innerWidth,n=mouse.y*canvas.h/window.innerHeight,s=n-this.translateY;let o=!1;if(this===menuInventory&&"menu"===window.state){const t=(t,e=!1)=>{if(!t||!t.menuActive)return!1;let a,s,o,l;return e&&t.dimensions?(a=t.dimensions.x,s=t.dimensions.y,o=t.dimensions.w,l=t.dimensions.h):void 0!==t.x&&void 0!==t.y?(a=t.x,s=t.y,o=t.w,l=t.h):(a=130,s=canvas.h-t.h-20,o=t.w,l=t.h),i>a&&i<a+o&&n>s&&n<s+l};(t(globalInventory)||t(specialGlobalInventory)||t(craftingMenu)||t(mobGallery,!0))&&(o=!0)}if(!o){for(let t in this.topPetalContainers){const e=this.topPetalContainers[t];i>e.x-e.w/2&&i<e.x+e.w/2&&s>e.y-e.h/2&&s<e.y+e.h/2&&(e.isHovered=!0),e.drawStatsBox(this===menuInventory,!1,e.render.x,e.render.y+this.translateY)}for(let t in this.bottomPetalContainers){const e=this.bottomPetalContainers[t];i>e.x-e.w/2&&i<e.x+e.w/2&&s>e.y-e.h/2&&s<e.y+e.h/2&&(e.isHovered=!0),e.drawStatsBox(this===menuInventory,!1,e.render.x,e.render.y+this.translateY)}if(this.artifactContainer){const t=this.artifactSlot,e="menu"===window.state;this.artifactContainer.drawStatsBox(e,!1,t.x,t.y+this.translateY)}}}updateBiome(){for(let t in this.topPetalContainers){const e=this.topPetalContainers[t];e.draw(),!0===e.greyed&&(isSpecialPetal(e)?specialGlobalInventory.addPetalContainer(e):globalInventory.addPetalContainer(e),this.removePetalContainer(!1,t))}for(let t in this.bottomPetalContainers){const e=this.bottomPetalContainers[t];e.draw(),!0===e.greyed&&(isSpecialPetal(e)?specialGlobalInventory.addPetalContainer(e):globalInventory.addPetalContainer(e),this.removePetalContainer(!0,t))}}updateSavedPetals(){localStorage.setItem("savedPetals",JSON.stringify({top:this.topPetalContainers,bottom:this.bottomPetalContainers})),!0===window.loaded&&this===menuInventory&&(this.queueSendChangedPetals(),squadUI.updateSelfFlowerPetals({top:this.topPetalContainers,bottom:this.bottomPetalContainers}),"function"==typeof loadMenuPlayerPetals&&loadMenuPlayerPetals())}queueSendChangedPetals(){const t=this.pack();this.queuedChangedPetals=t}drawArtifactSlot(){const t=this.artifactSlot;if(this.artifactContainer||(ctx.strokeStyle="#ffd700",ctx.lineWidth=4,ctx.beginPath(),ctx.roundRect(t.x-t.size/2-2,t.y-t.size/2-2,t.size+4,t.size+4,8),ctx.stroke(),ctx.fillStyle="#ffd700",ctx.beginPath(),ctx.roundRect(t.x-t.size/2,t.y-t.size/2,t.size,t.size,6),ctx.fill()),this.artifactContainer){if("undefined"!=typeof specialGlobalInventory&&specialGlobalInventory.equippedArtifact){const t=specialGlobalInventory.artifacts[specialGlobalInventory.equippedArtifact];if(t&&t.skillLevels){const e=Object.values(t.skillLevels).reduce((t,e)=>t+e,0)-1;e>0&&(this.artifactContainer.rarity=e,Stats.petals[this.artifactContainer.type]&&Stats.petals[this.artifactContainer.type][e]&&(this.artifactContainer.petalStats=Stats.petals[this.artifactContainer.type][e]))}}this.artifactContainer.draw()}else ctx.font="900 24px Ubuntu",ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.textAlign="center",ctx.textBaseline="middle",ctx.strokeText("?",t.x,t.y),ctx.fillText("?",t.x,t.y);const e=mouse.x*canvas.w/window.innerWidth,a=mouse.y*canvas.h/window.innerHeight-this.translateY;this.artifactContainer&&e>t.x-t.size/2&&e<t.x+t.size/2&&a>t.y-t.size/2&&a<t.y+t.size/2&&(this.artifactContainer.isHovered=!0)}pack(){return{top:mapObject(this.topPetalContainers,t=>({rarity:t.rarity,type:t.type})),bottom:mapObject(this.bottomPetalContainers,t=>({rarity:t.rarity,type:t.type}))}}}function mapObject(t,e){let a={};for(let i in t)a[i]=e(t[i]);return a}class PetalSlot{constructor(t){this.x=t.x,this.y=t.y,this.size=t.size}draw(t){ctx.globalAlpha=.8*t,ctx.fillStyle="#eeeeee",ctx.strokeStyle="#bebebe",ctx.lineWidth=6,ctx.beginPath(),ctx.roundRect(this.x-this.size/2+1,this.y-this.size/2+1,this.size-2,this.size-2,this.size/10),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.globalAlpha=1}}