let ver=document.scripts[0].src.split("v=")[1];ver||"localhost:8080"!=location.host||(ver="Developer");let ws,servers={"ws://localhost:8080/ws":"Local"};function initWS(){ws=new WebSocket(HOST),ws.binaryType="arraybuffer",ws.onopen=handleOpen,ws.onmessage=handleMessage,ws.onclose=handleClose}function startKeepAlive(){window.keepAlive=[setInterval(()=>{"game"!==window.state&&send({ping:!0})},2e4),setInterval(()=>{"game"==window.state&&performance.now()-window.lastMessageTimeReceived>5e3&&(ws.onopen=null,ws.onmessage=null,ws.onclose=null,ws.onerror=null,ws.close(1e3,"manual reconnection"),handleClose(),window.lastMessageTimeReceived=performance.now())},1e3)]}function stopKeepAlive(){window.keepAlive.forEach(e=>clearInterval(e))}function handleOpen(){if(startKeepAlive(),!0===window.reconnecting&&!window.connectBackMainServ){const e={reconnect:!0,id:window.reconnectId};void 0!==window.connectOtherServerId?(e.connectOtherServerId=window.connectOtherServerId,delete window.connectOtherServerId,window.state="menu"):window.state="game",ws.send(msgpackr.pack(e)),wsMsgQueue=[],setTimeout(sendQueuedMessages,100),window.reconnectTries=20}ws.onerror=()=>{},window.reconnecting=!1,window.connectBackMainServ&&(window.state="menu",delete window.connectBackMainServ),ws.binaryType="arraybuffer",window.connected=!0,window.connectedTime=window.time,document.querySelector(".grid").classList.add("show"),!0===window.skipLogin&&!0!==window.reconnecting&&send({login:{username,hashedPassword,hashedPassword2}})}function handleMessage(e){if(window.lastMessageTimeReceived=performance.now(),"game"===window.state)try{let n=msgpackr.unpack(e.data);if(n&&"object"==typeof n){Object.keys(n)}processGameMessage(n)}catch(n){if(e.data.byteLength%4==0){const n=new Float32Array(e.data);"function"==typeof processRawMessage[n[0]]&&processRawMessage[n[0]](n)}}else{let n=msgpackr.unpack(e.data);processMenuMessage(n)}}function handleClose(e){stopKeepAlive(),delete window.connectedTime,window.state="disconnected",e&&e.reason&&""!=e.reason?window.connected=!1:["game","disconnected"].includes(window.state)||void 0!==window.connectOtherServerId?window.reconnectTries>0&&(wsMsgQueue.length=0,send=e=>{wsMsgQueue.push(e)},window.reconnecting=!0,setTimeout(attemptReconnect,timeBetweenReconnects(window.reconnectTries))):window.connected=!1}function attemptReconnect(){initWS(),ws.onerror=e=>{},window.reconnectTries--}function timeBetweenReconnects(e){return 500+1e3*(20-e)}HOST="wss://thoita-prod-7gydki1s27ab5d0f-1398459068.ap-shanghai.run.wxcloudrun.com/ws",window.state=null===localStorage.getItem("hashedPassword")?"account":"menu",window.skipLogin="account"!==window.state,window.connected=!1,window.spectating=!1,window.reconnectTries=20,window.reconnecting=!1,window.lastMessageTimeReceived=performance.now(),window.keepAlive=[],initWS(),window.onload=()=>{resize(),document.querySelector(".loader").style.animation="fadeOut .2s",setTimeout(()=>{document.querySelector(".loader").remove()},200-1e3/60*2);for(let e=0;e<onLoadFunctions.length;e++)onLoadFunctions[e]();onLoadFunctions.length=0,window.loaded=!0,send=(e,n)=>{!n&&window.reconnecting||ws.send(msgpackr.pack(e))};for(let e=0;e<wsMsgQueue.length;e++)send(wsMsgQueue[e])};const customCodeBiomeNames=["Rainforest_cc","petri_dish","Slime","Mutated_Garden","Freshwater_Lake"],playButton=document.querySelector(".play-btn"),playText=document.querySelector(".play-text");let lastAttempt=Date.now();function loadCustomCodeBiome(e){const n=document.createElement("iframe");n.src=`${location.origin}/customBiome/${e}`;const o=document.querySelector(".menu");n.style.position="fixed",n.style.top=0,n.style.left=0,n.style.width="100%",n.style.height="100%",n.style.zIndex="99999999999999999",o.appendChild(n),window.addEventListener("message",e=>{unloadCustomCodeBiome(n)}),n.onload=()=>{n.contentWindow.postMessage([menuInventory.pack().top,Math.round(200*squadUI.startingWaveSlider+1)])}}function unloadCustomCodeBiome(e){e.remove(),squadUI.reset(),closeSquadUI()}playButton.onclick=e=>{const n=biomeManager.getCurrentBiome(),o=customCodeBiomeNames.includes(n);if(squadUI.isCustomCode=o,!0===o&&processMenuMessage({squadInit:!0,clients:[{name:"",id:1,ready:!1,sw:200,maxSW:200,petals:[],username:""}],public:!1,selfId:1,biome:n}),"Ready"===playText.getAttribute("stroke")){if(!0===o)return void loadCustomCodeBiome(n);changeReady(!window.ready)}else{if(!window.connected)return;squadUI.reset(),window.squadUIEnabled=!0,playText.setAttribute("stroke","Ready"),changeReady(!1)}};let wsMsgQueue=[],send=e=>{wsMsgQueue.push(e)};function sendQueuedMessages(){let e=setInterval(()=>{if(0==wsMsgQueue.length)return clearInterval(e),void(send=e=>{ws.send(msgpackr.pack(e))});ws.send(msgpackr.pack(wsMsgQueue.shift()))},100)}if(location.href.endsWith("/3d")){window.is3D=!0;const e=document.createElement("script");e.type="module",e.src="systems/3d.js",document.body.append(e)}