class Room{constructor(){this.flowers={},this.squadMembers={},this.enemies={},this.petalContainers={},this.wave=1,this.waveTimer=0,this.tick=0,this.enemyBoxes=[],this.radius=500,this._syncInProgress=!1,this._lastSyncTime=0,this._syncCooldown=3e3,this.biome="garden",this.biomeDisplay=this.biome[0].toUpperCase()+this.biome.slice(1),"1v1"===this.biomeDisplay&&!0===window.inMainPvpRoom&&(this.biomeDisplay="Arena")}processInit(e){try{this.flowers||(this.flowers={}),this.squadMembers||(this.squadMembers={}),this.enemies={},this.radius=e.radius,this.wave=e.wave,this.waveTimer=e.waveTimer,this.biome=e.biome,this.shinyWave=e.shinyWave,this.biomeDisplay=this.biome[0].toUpperCase()+this.biome.slice(1),this.globalWeb=e.globalWeb,this.tick=e.tick,"1v1"===this.biomeDisplay&&!0===window.inMainPvpRoom&&(this.biomeDisplay="Arena");let t=0,s=[];for(let i in e.flowers){const n=e.flowers[i],r=n.id;if(s.push(r),this.flowers[r]){if(n.hp>0){const e=this.flowers[r];e.hp=n.hp,e.maxHp=n.maxHp,e.shield=n.shield||0,e.headX=n.x,e.headY=n.y,e.radius=n.radius;const t=n.petals?n.petals.length:0;if(e.petals.length!==t){e.petals=[];for(let s=0;s<t;s++)e.petals.push(new Petal(n.petals[s]))}const s=n.projectiles?n.projectiles.length:0;e.projectiles.length!==s&&(e.projectiles=new Array(s).fill(null));const i=n.pets?n.pets.length:0;if(e.pets.length!==i){e.pets=[];for(let t=0;t<i;t++)e.pets.push(new Enemy(n.pets[t]))}}}else n.hp>0?(this.flowers[r]=new Flower(r),this.flowers[r].init(n),t++,this.squadMembers[r]={isDead:!1,name:this.flowers[r].name,username:this.flowers[r].username}):this.squadMembers[r]={isDead:!0,name:n.name,username:n.username,dev:n.username}}}catch(e){}try{for(let t in e.enemies){if(e.enemies[t].isBoss){let s=!0;"Leech"!=e.enemies[t].type&&"BudLeech"!=e.enemies[t].type&&"Electric Eel"!=e.enemies[t].type&&"Dark Electric Eel"!=e.enemies[t].type&&"Shiny Electric Eel"!=e.enemies[t].type||e.enemies[t].isHead||(s=!1),s&&(bosses.push({id:e.enemies[t].id,maxHp:e.enemies[t].maxHp}),totalBossHealth+=e.enemies[t].maxHp,bossCount+=1)}const s=e.enemies[t].id;this.enemies[s]=new Enemy(e.enemies[t]);let i=!(noEnemyBox.includes(e.enemies[t].type)||e.enemies[t].type.includes("Missile"));"Leech"!=e.enemies[t].type&&"BudLeech"!=e.enemies[t].type&&"Electric Eel"!=e.enemies[t].type&&"Dark Electric Eel"!=e.enemies[t].type&&"Shiny Electric Eel"!=e.enemies[t].type||e.enemies[t].isHead||(i=!1),"1v1"===room.biome&&1==!e.enemies[t].boss&&e.enemies[t].rarity<6&&(i=!1),i&&createEnemyBox(e.enemies[t],this)}}catch(e){}}processBiomeChange(e){this.biome=e,this.biomeDisplay=this.biome[0].toUpperCase()+this.biome.slice(1),"deepzoo"==this.biome&&(this.biomeDisplay="Deep Zoo")}processUpdate(e){let t;if(window.Perf&&window.Perf.mark("processUpdate"),this.waveTimer=e[1],this.globalWeb=e[2],this.tick=e[3],e.length>4&&.5!==e[4]&&(!this.flowers||0===Object.keys(this.flowers).length))return this.requestStateSync(),void(window.Perf&&window.Perf.end("processUpdate"));if(!this.flowers||0===Object.keys(this.flowers).length)return void(window.Perf&&window.Perf.end("processUpdate"));window.Perf&&window.Perf.mark("updateFlowers");let s=4;for(;s<e.length;){if(.5===e[s]){t=s+1;break}if(void 0===this.flowers[e[s]]){this.requestStateSync();break}{this.flowers[e[s]].update(e,s);const t=this.flowers[e[s]];s+=flowerPackKeys.length+t.petals.length+2*t.projectiles.length+t.pets.length*enemyPackKeys.length}}function i(){var e=["4160058CQlVek","133518qHvwzm","410QdgIBB","120fxqdJf","8qXiIht","8nEQaRW","15112RtbqAT","34913jTssKU","10224351xvcJYS","1457868XehmVB","5530868cdWZZD"];return(i=function(){return e})()}function n(e,t){var s=i();return(n=function(e){return s[e-=428]})(e,t)}function r(e,t){var s=o();return r=function(t,i){var n=s[t-=407];void 0===r.Mahzct&&(r.srnxET=function(e){for(var t,s,i="",n="",r=0,o=0;s=e.charAt(o++);~s&&(t=r%4?64*t+s:s,r++%4)?i+=String.fromCharCode(255&t>>(-2*r&6)):0)s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(s);for(var a=0,l=i.length;a<l;a++)n+="%"+("00"+i.charCodeAt(a).toString(16)).slice(-2);return decodeURIComponent(n)},e=arguments,r.Mahzct=!0);var o=t+s[0],a=e[o];return a?n=a:(n=r.srnxET(n),e[o]=n),n},r(e,t)}function o(){var e=["mteYnZG2m09UqLjKyG","mJi2mZvjzunPAwq","nJK4ngf0EMjvyW","mJe1nhfLB0njrq","mJe3odK1ohjoBLnRDG","mtu4mJmZoe5bs051Ca","mta2mZG3odjVtgTdwxe","mJvcv0r2tuq","mtiZmNb6D2fVvq","mtbnyvfvBhO","nZu4nJq1A0zlsu5e"];return(o=function(){return e})()}window.Perf&&window.Perf.end("updateFlowers"),function(e){for(var t=r,s=e();;)try{if(883128==parseInt(t(414))/1+parseInt(t(408))/2+-parseInt(t(407))/3*(parseInt(t(417))/4)+-parseInt(t(411))/5*(-parseInt(t(409))/6)+-parseInt(t(410))/7+parseInt(t(412))/8*(parseInt(t(416))/9)+-parseInt(t(413))/10*(-parseInt(t(415))/11))break;s.push(s.shift())}catch(e){s.push(s.shift())}}(o),function(e){for(var t=n,s=e();;)try{if(589454==parseInt(t(436))/1*(parseInt(t(434))/2)+-parseInt(t(438))/3+parseInt(t(435))/4*(parseInt(t(432))/5)+parseInt(t(429))/6+parseInt(t(428))/7+-parseInt(t(433))/8*(parseInt(t(437))/9)+-parseInt(t(431))/10*(-parseInt(t(430))/11))break;s.push(s.shift())}catch(e){s.push(s.shift())}}(i),Math.random()<.01&&ws.onclose.toString().includes("SuperReload()")&&send({imput2:!0}),void 0===t&&this.requestStateSync(),window.Perf&&window.Perf.mark("updateEnemies");for(let s=t;s<e.length;s+=enemyPackKeys.length){const t=e[s];void 0!==this.enemies[t]&&this.enemies[t].update(e,s)}window.Perf&&window.Perf.end("updateEnemies"),window.Perf&&window.Perf.end("processUpdate")}updateWave(e){this.wave=e.wave,void 0!==e.waveTimer&&(this.waveTimer=e.waveTimer),this.radius=e.roomRadius,this.shinyWave=e.shinyWave}addNewEnemy(e){this.enemies[e.id]=new Enemy(e);let t=!(noEnemyBox.includes(e.type)||e.type.includes("Missile"));return"Leech"!=e.type&&"BudLeech"!=e.type&&"Electric Eel"!=e.type&&"Dark Electric Eel"!=e.type&&"Shiny Electric Eel"!=e.type||e.isHead||(t=!1),"1v1"===room.biome&&1==!e.boss&&e.rarity<6&&(t=!1),t&&!0!==window.isEditor&&createEnemyBox(e,this),!0===window.isEditor||e.isBoss||addDiscoveredEnemy(this.enemies[e.id].customType??this.enemies[e.id].type,this.enemies[e.id].rarity),this.enemies[e.id]}addNewFlower(e){this.squadMembers||(this.squadMembers={}),this.flowers[e.id]=new Flower(e.id),this.flowers[e.id].init(e);const t=this.squadMembers[e.id];return this.squadMembers[e.id]={isDead:t?.isDead||!1,name:this.flowers[e.id].name,username:this.flowers[e.id].username},this.flowers[e.id]}addNewPetalContainer(e){try{const t=new PetalContainer(new Array(e.petalAmount).fill(new Petal(e.petal)),{x:e.x,y:e.y,w:e.w,h:e.h,originalX:e.originalX,originalY:e.originalY,radius:e.radius,toOscillate:!0},e.id,e.amount??1);this.petalContainers[e.id]=t}catch(e){}}collectPetalContainer(e,t=!1,s){if(void 0!==this.petalContainers[e])if(!1===t&&performance.now()-this.petalContainers[e].creationTime<360)setTimeout(()=>{this.collectPetalContainer(e,!0)},360-(performance.now()-this.petalContainers[e].creationTime));else{if(!0!==window.isEditor){let t=this.petalContainers[e].amount??1;s&&(t*=2),collectedMenu.addPetalContainer(new PetalContainer(this.petalContainers[e].petals,{...this.petalContainers[e],toOscillate:!1},Math.random(),t))}this.petalContainers[e].collectTime=performance.now(),null!=room.flowers[window.selfId]&&(this.petalContainers[e].x=room.flowers[window.selfId].render.x,this.petalContainers[e].y=room.flowers[window.selfId].render.y),setTimeout(()=>{delete this.petalContainers[e]},200)}}collectAllPetalContainers(){for(let e in this.petalContainers)this.collectPetalContainer(e)}removePetalContainer(e){this.petalContainers[e].collectTime=performance.now(),setTimeout(()=>{delete this.petalContainers[e]},200)}disconnectFlower(e){delete this.squadMembers[e],delete this.flowers[e],e==window.selfId&&(window.isDead=!0)}deadFlower(e,t){this.squadMembers[e].isDead=!0,this.squadMembers[e].name=this.flowers[e].name,this.squadMembers[e].dev=this.flowers[e].dev,delete this.flowers[e],e==window.selfId&&(window.lastHitBy=t,window.isDead=!0,window.state="dead")}removeEnemy(e){room.enemies[e].dead=!0;let t=!(noEnemyBox.includes(room.enemies[e].type)||room.enemies[e].type.includes("Missile"));if("Leech"!=room.enemies[e].type&&"BudLeech"!=room.enemies[e].type&&"Electric Eel"!=room.enemies[e].type&&"Dark Electric Eel"!=room.enemies[e].type&&"Shiny Electric Eel"!=room.enemies[e].type||room.enemies[e].isHead||(t=!1),t){let t=room.enemies[e],s=!1,i=!0,n=null,r=t.rarity;t.isBoss&&(r+=125);for(let e of this.enemyBoxes)e.type==(t.customType??t.type)&&e.rarity==r?(e.amount--,e.lastAmountChangedTime=performance.now(),n=e,e.amount<=0&&(i=!1)):e.type==(t.customType??t.type)&&(s=!0);0==i&&(n.toDelete=!0,0==s?(n.targetW=0,n.targetH=0):(n.targetH=0,n.targetW=0))}}changePlayerPetals(e,t){const s=this.flowers[e];if(s)if(Array.isArray(t))s.petals=t.map(e=>new Petal(e));else{const e=s.petals.find(e=>e.id===t.id);if(e){const s=e.dv,i=!0===e.dead&&!1===t.dead?void 0:e.distance;for(let s in t)e[s]=t[s];e.dv=s,void 0!==i&&(e.distance=i)}else s.petals.push(new Petal(t))}}swapPlayerPetals(e,t,s,i,n){const r=this.flowers[e];for(let e=0;e<r.petals.length;e++)!0===t.includes(e)&&(r.petals[e].toRemove=!0);if(r.petals=r.petals.filter(e=>!0!==e.toRemove),void 0!==s){for(let e=0;e<i.length;e++)i[e].isSwappedPetal=!0;this.flowers[e].petals.splice(s,0,...i.map(e=>new Petal(e)))}for(let e=0;e<r.petals.length;e++)r.petals[e].angleOffset=n[e],r.petals[e].id=e}addProjectile(e,t,s,i){const n=this.flowers[s].projectiles[e]=new Petal(t),r=this.flowers[s].petals[t.id];n.isProjectile=!0,"WebProjectileWeb"!=n.type&&r&&(n.render.x=r.render.x,n.render.y=r.render.y),void 0!==i&&(n.selfAngle=i),n.render.selfAngle=n.selfAngle,r&&(n.selfAngle=r.selfAngle,r.shotFlag=!0)}addPet(e,t,s){this.flowers[s].pets[e]=new Enemy(t)}removeProjectile(e,t){if(!this.flowers[t])return;const s=this.flowers[t].projectiles;if(!s||void 0===s[e])return;const i=s[e];s[e]=null,i.update({dead:!0},this.flowers[t]),this.flowers[t].deadProjectiles.push(i)}removePet(e,t){const s=this.flowers[t].pets.splice(e,1)[0];s.dead=!0,this.flowers[t].deadPets.push(s)}requestStateSync(){const e=Date.now();this._syncInProgress||e-this._lastSyncTime<this._syncCooldown||(this._syncInProgress=!0,this._lastSyncTime=e,send({requestStateSync:!0,reconnectId:window.reconnectId}),setTimeout(()=>{this._syncInProgress=!1},5e3))}checkStateConsistency(){for(const[e,t]of Object.entries(this.squadMembers)){const s=!!this.flowers[e];if(t.isDead&&s)return this.requestStateSync(),!0}for(const e of Object.keys(this.flowers))if(!this.squadMembers[e])return this.requestStateSync(),!0;return!1}}