const ROMAN_NUMERALS=["I","II","III","IV","V","VI","VII","VIII","IX","X"];function createLinearSkillChain(t,e,i,a,s,l,o,r,n){const c=[];for(let x=1;x<=a;x++){const a=ROMAN_NUMERALS[x-1]||x;c.push({id:`${t}_${x}`,name:`${e} ${a}`,description:i,maxLevel:1,costPerLevel:s,requires:1===x?l:[`${t}_${x-1}`],statKey:o,baseValue:r,valuePerLevel:n})}return c}const SKILL_TREES={"Abyssal Artifact":{name:"Abyssal Artifact",description:"Enhances Egg petal performance",color:"#7b68ee",icon:"ðŸ¥š",passiveEffects:{eggHpMultiplier:1.4,eggMassMultiplier:1.4,eggDamageMultiplier:1.25},nodes:[{id:"root",name:"Egg Enhancement",description:"Enhances base Egg petal performance",maxLevel:1,costPerLevel:0,requires:[],statKey:null,baseValue:0,valuePerLevel:0,isRoot:!0},...createLinearSkillChain("egg_hp","HP Boost","Increases Egg HP multiplier",10,1,["root"],"eggHpMultiplier",1.4,.03),...createLinearSkillChain("egg_damage","Damage Boost","Increases Egg damage multiplier",10,1,["root"],"eggDamageMultiplier",1.25,.03),...createLinearSkillChain("egg_mass","Mass Boost","Increases Egg size (hitbox)",10,1,["egg_hp_3"],"eggMassMultiplier",1.4,.03),...createLinearSkillChain("cooldown","Cooldown Reduction","Reduces ultimate cooldown",10,1,["egg_damage_3"],"cooldown",60,-1.5),...createLinearSkillChain("duration","Death Delay","Extends bandage effect duration",5,2,["cooldown_3"],"duration",2,.1)]},"Scorched Artifact":{name:"Scorched Artifact",description:"Enhances healing and provides squad buffs",color:"#ff6b6b",icon:"ðŸ”¥",passiveEffects:{squadHealShare:.33,healMultiplier:1.2},nodes:[{id:"root",name:"Healing Enhancement",description:"Enhances healing effects",maxLevel:1,costPerLevel:0,requires:[],statKey:null,baseValue:0,valuePerLevel:0,isRoot:!0},...createLinearSkillChain("heal_mult","Heal Multiplier","Increases healing amount",10,1,["root"],"healMultiplier",1.2,.1),...createLinearSkillChain("ult_cd","Ult Cooldown","Reduces ultimate cooldown",6,1,["root"],"cooldown",60,-1.5),...createLinearSkillChain("duration","Buff Duration","Extends raid heal buff duration",8,1,["heal_mult_3"],"duration",7,.2),...createLinearSkillChain("heal_boost","Raid Boost","Increases raid heal buff effect",8,1,["ult_cd_3"],"healBoost",.3,.01)]},"Verdant Artifact":{name:"Verdant Artifact",description:"Increases damage output and petal performance",color:"#32cd32",icon:"ðŸŒ¿",passiveEffects:{dpsMultiplier:1.8},nodes:[{id:"root",name:"Frenzy Core",description:"Unlocks frenzy mode path",maxLevel:1,costPerLevel:0,requires:[],statKey:null,baseValue:0,valuePerLevel:0,isRoot:!0},...createLinearSkillChain("dps","DPS Boost","Increases overall damage output",10,1,["root"],"dpsMultiplier",1.2,.02),...createLinearSkillChain("ult_cd","Petal Cooldown","Reduces petal reload time",6,1,["root"],"cooldownReduction",0,.04),...createLinearSkillChain("duration","Frenzy Duration","Extends frenzy mode duration",6,1,["dps_3"],"duration",8,.2),...createLinearSkillChain("damage_mult","Frenzy Damage","Increases frenzy mode damage bonus",8,1,["ult_cd_3"],"damageMultiplier",0,.1)]},"Cosmic Artifact":{name:"Cosmic Artifact",description:"Enhances survivability and knockback effects",color:"#4169e1",icon:"âœ¨",passiveEffects:{hpMultiplier:1.2},nodes:[{id:"root",name:"Cosmic Power",description:"Masters the core of cosmic energy",maxLevel:1,costPerLevel:0,requires:[],statKey:null,baseValue:0,valuePerLevel:0,isRoot:!0},...createLinearSkillChain("hp_mult","HP Multiplier","Increases HP",8,1,["root"],"hpMultiplier",1.2,.1),...createLinearSkillChain("ult_cd","Skill Cooldown","Reduces shockwave cooldown",8,1,["root"],"cooldown",60,-1.5),...createLinearSkillChain("range","Knockback Range","Expands shockwave knockback range",6,1,["hp_mult_3"],"range",500,20),...createLinearSkillChain("knockback","Knockback Force","Bubble knockback force multiplier",10,1,["range_3"],"knockbackForce",1,.05)]}},ARTIFACT_TYPES=["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"];class SpecialGlobalInventory{constructor(){this.menuActive=!1,this.hoveringOverButton=!1,this.hoveringOverX=!1,this.fadingOut=!1,this.w=445,this.h=665,this.x=130,this.y=canvas.h-this.h-20,this.lastOpenTime=0,this.lastCloseTime=0,this.originalFadeOutTime=0,this.artifacts={},this.equippedArtifact=null,this.selectedArtifactIndex=-1,this.availableLevelPoints=0,this.nodePositions={},this.hoveredNode=null,this.hoveredArtifact=null,this.hoveredTooltip=null,this.skillTreeOffset={x:0,y:0},this.skillTreeRenderOffset={x:0,y:0},this.isDraggingSkillTree=!1,this.dragStartPos={x:0,y:0},this.hoveringOverReset=!1,this.lastArtifactResetTime=0,this.initDefaultArtifacts()}initDefaultArtifacts(){for(const t of ARTIFACT_TYPES){const e={},i=SKILL_TREES[t];for(const t of i.nodes)e[t.id]=0;const a=i.nodes.find(t=>t.isRoot);a&&(e[a.id]=1);const s=new Petal({type:t,rarity:0,x:0,y:0,distance:0,angle:0,maxHp:1e30,hp:1e30,maxReload:3,reload:3,damage:0}),l=new Petal({type:t,rarity:0,x:0,y:0,distance:0,angle:0,maxHp:1e30,hp:1e30,maxReload:3,reload:3,damage:0}),o=new PetalContainer([s],{x:0,y:0,w:65,h:65,originalX:0,originalY:0,radius:32.5,toOscillate:!1,petalStats:null},`${t}_artifact`,1,0);o.amount=0;const r=new PetalContainer([l],{x:0,y:0,w:65,h:65,originalX:0,originalY:0,radius:32.5,toOscillate:!1,petalStats:null},`${t}_artifact_render`,1,0);r.amount=0,r.x=0,r.y=0,r.render.x=0,r.render.y=0,r.spawnAnimation=1,this.artifacts[t]={skillLevels:e,totalLevelPoints:0,petalContainer:o,renderPetalContainer:r}}}addPetalContainer(t,e=!1,i=!0){if(!showCommunityBiomes&&!petalRenderMap[t.type])return;const a=t.type;if(!this.artifacts[a])return;const s=this.artifacts[a];s.petalContainer.amount=1,s.renderPetalContainer.amount=1,!1!==e&&send({addPetalContainer:{type:a,rarity:t.rarity||0,amount:1}})}removePetalContainer(t,e){for(const e of ARTIFACT_TYPES){const i=this.artifacts[e];if(i.petalContainer&&!(i.petalContainer.amount<=0)&&i.petalContainer.rarity===t){const t=i.petalContainer;return i.petalContainer.amount=0,i.renderPetalContainer.amount=0,t}}return null}removeByRarityAndType(t,e){const i=this.artifacts[e];return!!i&&(i.petalContainer?.rarity===t&&i.petalContainer?.amount>0&&(i.petalContainer,i.petalContainer.amount=0,i.renderPetalContainer.amount=0,!0))}getNodeLevel(t,e){return this.artifacts[t]?.skillLevels[e]||0}getNodeValue(t,e){const i=SKILL_TREES[t].nodes.find(t=>t.id===e);if(!i||!i.statKey)return null;const a=this.getNodeLevel(t,e);return i.baseValue+i.valuePerLevel*a}getArtifactValue(t,e){const i=SKILL_TREES[t],a=i.passiveEffects[e]||0;let s=0;for(const a of i.nodes)if(a.statKey===e){const e=this.getNodeLevel(t,a.id);s+=a.valuePerLevel*e}return a+s}isNodeUnlocked(t,e){const i=SKILL_TREES[t].nodes.find(t=>t.id===e);if(!i)return!1;if(i.isRoot)return!0;for(const e of i.requires)if(this.getNodeLevel(t,e)<1)return!1;return!0}canUpgradeNode(t,e){const i=SKILL_TREES[t].nodes.find(t=>t.id===e);return!!i&&(!i.isRoot&&(!!this.isNodeUnlocked(t,e)&&(!(this.getNodeLevel(t,e)>=i.maxLevel)&&this.availableLevelPoints>=i.costPerLevel)))}upgradeNode(t,e){if(!this.canUpgradeNode(t,e))return!1;const i=SKILL_TREES[t].nodes.find(t=>t.id===e),a=this.artifacts[t];return void 0===a.skillLevels[e]&&(a.skillLevels[e]=0),this.availableLevelPoints-=i.costPerLevel,a.skillLevels[e]++,a.totalLevelPoints+=i.costPerLevel,send({upgradeArtifact:{type:t,nodeId:e,level:a.skillLevels[e]}}),!0}equipArtifact(t){this.equippedArtifact=t,send({equipArtifact:t})}resetArtifactSkills(t){return send({resetArtifactSkills:{type:t}}),!0}loadArtifactData(t){if(t.artifacts)for(const e in t.artifacts)this.artifacts[e]&&(this.artifacts[e].skillLevels=t.artifacts[e].skillLevels||this.artifacts[e].skillLevels,this.artifacts[e].totalLevelPoints=t.artifacts[e].totalLevelPoints||0);t.equippedArtifacts&&Array.isArray(t.equippedArtifacts)?this.equippedArtifact=t.equippedArtifacts.length>0?t.equippedArtifacts[0]:null:void 0!==t.equippedArtifact&&(this.equippedArtifact=t.equippedArtifact),void 0!==t.availableSkillPoints?this.availableLevelPoints=t.availableSkillPoints:void 0!==t.availableLevelPoints&&(this.availableLevelPoints=t.availableLevelPoints),void 0!==t.lastArtifactResetTime&&(this.lastArtifactResetTime=t.lastArtifactResetTime)}drawIcon(t=1){const e=canvas.h-20-80-100-100-100;1!==t&&(ctx.globalAlpha=t),ctx.fillStyle="#5a9fdb",ctx.strokeStyle="#4981b1",mouse.canvasX>20&&mouse.canvasY>e&&mouse.canvasX<100&&mouse.canvasY<e+80?(ctx.fillStyle="#6aa8df",setCursor("pointer"),this.hoveringOverButton=!0):this.hoveringOverButton=!1,ctx.lineWidth=6,ctx.beginPath(),ctx.roundRect(20,e,80,80,3),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.font="900 40px Ubuntu",ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.textAlign="center",ctx.textBaseline="middle",ctx.strokeText("â­",60,e+40),ctx.fillText("â­",60,e+40),ctx.fillStyle="#f0f0f0",ctx.strokeStyle="black",ctx.lineWidth=2.25,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="900 14px Ubuntu";const i=ctx.letterSpacing;ctx.letterSpacing="0px",ctx.strokeText("[Z]",82.5,e+15),ctx.fillText("[Z]",82.5,e+15),ctx.letterSpacing=i,ctx.globalAlpha=1}toggleMenu(){!0===globalInventory.menuActive&&globalInventory.toggleMenu(),!0===craftingMenu.menuActive&&craftingMenu.toggleMenu(),!0===mobGallery.menuActive&&mobGallery.toggleMenu(),!0===this.menuActive?this.lastCloseTime=time:(this.lastOpenTime=time,this.selectedArtifactIndex>=0&&this.calculateNodePositions(ARTIFACT_TYPES[this.selectedArtifactIndex])),this.menuActive=!this.menuActive}draw(){let t=!0===this.fadingOut?1-(time-this.originalFadeOutTime)/100:1;!0===this.menuActive||time-this.lastCloseTime<140?this.drawMenu(t):(this.hoveringOverX=!1,this.hoveredNode=null)}drawMenu(t=1){1!==t&&(ctx.globalAlpha=t);let e=0;time-this.lastCloseTime<160&&(e+=this.h*easeOutCubic((time-this.lastCloseTime)/160)),time-this.lastOpenTime<160&&(e+=this.h+40-(this.h+40)*easeOutCubic((time-this.lastOpenTime)/160)),0!==e&&ctx.translate(0,e),this.x=130,this.y=canvas.h-this.h-20,ctx.translate(this.x,this.y),ctx.fillStyle="#5a9fdb",ctx.strokeStyle="#4981b1",ctx.lineWidth=8,ctx.save(),ctx.beginPath(),ctx.roundRect(0,0,this.w,this.h,3),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.save(),ctx.font="600 25px 'Ubuntu'",ctx.lineWidth=4,ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.textAlign="center",ctx.strokeText("Skills",this.w/2,25),ctx.fillText("Skills",this.w/2,25),ctx.font="700 20px 'Ubuntu'",ctx.fillStyle="#ffd700",ctx.strokeStyle="#000000",ctx.lineWidth=3,ctx.textAlign="left",ctx.strokeText(`â­ ${this.availableLevelPoints}`,15,27),ctx.fillText(`â­ ${this.availableLevelPoints}`,15,27),ctx.restore();const i=mouse.canvasX-this.x,a=mouse.canvasY-this.y;this.hoveredNode=null,this.hoveredArtifact=null;const s=65*ARTIFACT_TYPES.length+10*(ARTIFACT_TYPES.length-1),l=(this.w-s)/2,o=l-15,r=s+30;ctx.fillStyle="rgba(0, 0, 0, 0.3)",ctx.beginPath(),ctx.roundRect(o+3,58,r,85,10),ctx.fill(),ctx.closePath();const n=ctx.createLinearGradient(o,55,o,140);n.addColorStop(0,"rgba(70, 80, 100, 0.6)"),n.addColorStop(1,"rgba(50, 60, 80, 0.5)"),ctx.fillStyle=n,ctx.strokeStyle="rgba(200, 200, 220, 0.5)",ctx.lineWidth=2,ctx.beginPath(),ctx.roundRect(o,55,r,85,10),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=1,ctx.beginPath(),ctx.roundRect(o+3,58,r-6,79,8),ctx.stroke(),ctx.closePath();for(let t=1;t<ARTIFACT_TYPES.length;t++){const e=l+75*t-5;ctx.strokeStyle="rgba(255, 255, 255, 0.1)",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(e,63),ctx.lineTo(e,132),ctx.stroke(),ctx.closePath()}for(let t=0;t<ARTIFACT_TYPES.length;t++){const e=ARTIFACT_TYPES[t],s=SKILL_TREES[e],o=l+75*t+32.5,r=97.5,n=this.artifacts[e],c=n.renderPetalContainer;if(c){c.x=o,c.y=r,c.render.x=o,c.render.y=r;const l=i>o-32.5&&i<o+32.5&&a>r-32.5&&a<r+32.5,x=this.selectedArtifactIndex===t;l&&(this.hoveredArtifact={type:e,x:o,y:r,renderPc:c},setCursor("pointer")),x&&(ctx.fillStyle="rgba(255, 236, 139, 0.3)",ctx.strokeStyle=s.color,ctx.lineWidth=3,ctx.beginPath(),ctx.roundRect(o-32.5-3,r-32.5-3,71,71,8),ctx.fill(),ctx.stroke(),ctx.closePath());const h=Object.values(n.skillLevels).reduce((t,e)=>t+e,0)-1;h>0&&(c.rarity=Math.min(h,34)),c.amount>0?c.draw():(ctx.globalAlpha=.3,c.draw(),ctx.globalAlpha=1)}}if(this.selectedArtifactIndex>=0){const t=ARTIFACT_TYPES[this.selectedArtifactIndex];this.drawSkillTree(t,i,a),this.drawResetButton(i,a,t)}else ctx.fillStyle="rgba(255, 255, 255, 0.5)",ctx.font="500 12px 'Ubuntu'",ctx.textAlign="center",ctx.fillText("ç‚¹å‡»ä¸Šæ–¹ç¥žå™¨æŸ¥çœ‹æŠ€èƒ½æ ‘",this.w/2,this.h/2);if(ctx.restore(),ctx.fillStyle="#5a9fdb",ctx.strokeStyle="#4981b1",ctx.lineWidth=8,ctx.beginPath(),ctx.roundRect(0,0,this.w,this.h,3),ctx.stroke(),ctx.closePath(),this.hoveredNode)this.drawTooltip(this.hoveredNode);else if(this.hoveredArtifact&&this.hoveredArtifact.renderPc){const t=this.hoveredArtifact.renderPc,e=this.artifacts[this.hoveredArtifact.type];if(e&&e.skillLevels){const i=Object.values(e.skillLevels).reduce((t,e)=>t+e,0)-1;i>0&&(t.rarity=Math.min(i,34))}t.petalStats||"undefined"==typeof Stats||(t.petalStats=Stats.petals[t.type]?.[0]||null),t.isHovered=!0;const i="petals",a=new StatsBox(t.type,t.petalStats,i,t.amount,t.rarity);delete a.image;const s=ctx,l=document.createElement("canvas");ctx=l.getContext("2d"),a.draw(),ctx=s;const o=this.hoveredArtifact.x,r=this.hoveredArtifact.y,n=a.h,c=-(r-n-t.h/2-11.5),x=r+t.h/2+11.5+n-this.h<c||c<0;t.drawStatsBox(x,!1,o,r)}this.drawCloseButton(i,a),ctx.translate(-this.x,-this.y),0!==e&&ctx.translate(0,-e),ctx.globalAlpha=1}calculateNodePositions(t){const e=SKILL_TREES[t];this.nodePositions={};const i=this.w-120,a=e.nodes.find(t=>t.isRoot);if(!a)return;const s=60+i/2,l=190;this.nodePositions[a.id]={x:s,y:l,radius:32};const o=e.nodes.filter(t=>!t.isRoot);if(0===o.length)return;const r=o.filter(t=>1===t.requires.length&&"root"===t.requires[0]),n={};for(const t of e.nodes)n[t.id]=t;r.forEach((t,e)=>{const i=e%2==0,a=i?.75*Math.PI:.25*Math.PI,r=this.getLinearChain(t.id,n);if(r.forEach((t,e)=>{let o,n;if(0===e){const t=120,e=a-(i?.4:-.4);o=s+Math.cos(e)*t,n=l+Math.sin(e)*t}else if(1===e){const t=240,e=a-(i?.5:-.5);o=s+Math.cos(e)*t,n=l+Math.sin(e)*t}else if(2===e){const t=360,e=a-(i?.4:-.4);o=s+Math.cos(e)*t,n=l+Math.sin(e)*t}else{const t=this.nodePositions[r[e-1].id],a=120*(1-.1*(e-3)),s=[i?Math.PI:0,i?4*Math.PI/3:5*Math.PI/3,i?5*Math.PI/3:4*Math.PI/3,i?0:Math.PI,i?1*Math.PI/3:2*Math.PI/3,i?2*Math.PI/3:1*Math.PI/3],l=s[(e-3)%s.length];o=t.x+Math.cos(l)*a,n=t.y+Math.sin(l)*a}this.nodePositions[t.id]={x:o,y:n,radius:26}}),r.length>=3){const t=r[2],e=this.nodePositions[t.id];this.drawChildBranches(t,e,o,n,120,26)}})}drawChildBranches(t,e,i,a,s,l){const o=t.id.lastIndexOf("_"),r=t.id.substring(0,o+1);i.filter(e=>1===e.requires.length&&e.requires[0]===t.id&&!e.id.startsWith(r)).forEach(t=>{const o=this.getLinearChain(t.id,a),r=.75*Math.PI;if(o.forEach((t,i)=>{let a,n;if(0===i){const t=s,i=r-1.4;a=e.x+Math.cos(i)*t,n=e.y+Math.sin(i)*t}else if(1===i){const t=2*s,i=r-1;a=e.x+Math.cos(i)*t,n=e.y+Math.sin(i)*t}else if(2===i){const t=3*s,i=r-.8;a=e.x+Math.cos(i)*t,n=e.y+Math.sin(i)*t}else{const t=this.nodePositions[o[i-1].id],e=s*(1-.1*(i-3)),l=[Math.PI,4*Math.PI/3,5*Math.PI/3,0,1*Math.PI/3,2*Math.PI/3],r=l[(i-3)%l.length];a=t.x+Math.cos(r)*e,n=t.y+Math.sin(r)*e}this.nodePositions[t.id]={x:a,y:n,radius:l}}),o.length>=3){const t=o[2],e=this.nodePositions[t.id];this.drawChildBranches(t,e,i,a,s,l)}})}getLinearChain(t,e){const i=[];let a=t;const s=new Set;for(;a&&!s.has(a);){s.add(a);const t=e[a];if(!t)break;i.push(t);let l=null;for(const[t,i]of Object.entries(e))if(1===i.requires.length&&i.requires[0]===a){l=t;break}a=l}return i}layoutBranchSpiral(t,e,i,a){if(0===t.length)return;const s=-Math.PI/4;t.forEach((t,l)=>{let o,r;if(l<3){const t=100*(l+1);o=e+Math.cos(s)*t,r=i+Math.sin(s)*t}else{const t=l-3,a=300,s=Math.PI+.6*t,n=a-15*t;o=e+Math.cos(s)*n,r=i+Math.sin(s)*n}this.nodePositions[t.id]={x:o,y:r,radius:a}})}layoutSubBranchSpiral(t,e,i,a){if(0===t.length)return;const s=Math.PI/2;t.forEach((t,l)=>{let o,r;if(l<3){const t=100*(l+1);o=e+Math.cos(s)*t,r=i+Math.sin(s)*t}else{const t=l-3,a=300,s=Math.PI/2+.6*t,n=a-15*t;o=e+Math.cos(s)*n,r=i+Math.sin(s)*n}this.nodePositions[t.id]={x:o,y:r,radius:a}})}drawSkillTree(t,e,i){const a=SKILL_TREES[t];0===Object.keys(this.nodePositions).length&&this.calculateNodePositions(t);const s=this.w,l=this.h-140;this.skillTreeRenderOffset.x=interpolate(this.skillTreeRenderOffset.x,this.skillTreeOffset.x,.1*dt/16.66),this.skillTreeRenderOffset.y=interpolate(this.skillTreeRenderOffset.y,this.skillTreeOffset.y,.1*dt/16.66),ctx.save(),ctx.beginPath(),ctx.rect(0,140,s,l),ctx.clip(),ctx.closePath(),ctx.translate(this.skillTreeRenderOffset.x,this.skillTreeRenderOffset.y),ctx.setLineDash([4,8]),ctx.lineDashOffset=0,ctx.lineWidth=9,ctx.strokeStyle="rgba(255, 255, 255, 0.6)";for(const t of a.nodes){if(t.isRoot)continue;const e=this.nodePositions[t.id];if(e)for(const i of t.requires){const t=this.nodePositions[i];t&&(ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(e.x,e.y),ctx.stroke(),ctx.closePath())}}ctx.setLineDash([]);for(const s of a.nodes)this.drawSkillNode(t,s,e,i);ctx.restore()}drawSkillNode(t,e,i,a){const s=this.nodePositions[e.id];if(!s)return;const l=i-this.skillTreeRenderOffset.x,o=a-this.skillTreeRenderOffset.y,r=this.getNodeLevel(t,e.id),n=this.isNodeUnlocked(t,e.id),c=this.canUpgradeNode(t,e.id),x=r>=e.maxLevel,h=l>s.x-s.radius&&l<s.x+s.radius&&o>s.y-s.radius&&o<s.y+s.radius;let d,f;if(h&&!e.isRoot&&(this.hoveredNode={artifactType:t,node:e,pos:s},setCursor("pointer")),e.isRoot?(d=t===this.equippedArtifact?"#ffd700":"#daa520",f="#b8860b"):n?x?(d="#32cd32",f="#228b22"):r>0?(d=c?"#90ee90":"#6aa8df",f=c?"#32cd32":"#4981b1"):(d=c?"#ffec8b":"#999999",f=c?"#ffd700":"#777777"):(d="#888888",f="#666666"),e.isRoot||(ctx.fillStyle=d,ctx.strokeStyle=f,ctx.lineWidth=h?4:3,ctx.beginPath(),ctx.arc(s.x,s.y,s.radius,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.closePath()),!e.isRoot&&!x){const t=e.costPerLevel;ctx.font="700 12px Ubuntu",ctx.fillStyle=c?"#ffd700":"#888888",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.textAlign="right",ctx.textBaseline="top",ctx.strokeText(`${t}`,s.x+s.radius-2,s.y-s.radius+2),ctx.fillText(`${t}`,s.x+s.radius-2,s.y-s.radius+2)}e.isRoot?this.drawRootFlower(s.x,s.y,s.radius):this.drawNodeIcon(e,s.x,s.y)}drawRootFlower(t,e,i){ctx.fillStyle="#ffe763",ctx.strokeStyle="#cebb50",ctx.lineWidth=i/8,ctx.beginPath(),ctx.lineTo(t+1.03*i,e+-.02*i),ctx.quadraticCurveTo(t+.78*i,e+1.06*i,t+.27*i,e+1.14*i),ctx.quadraticCurveTo(t+-.8*i,e+.75*i,t+-.94*i,e+.36*i),ctx.quadraticCurveTo(t+-1.18*i,e+-.29*i,t+-.83*i,e+-.95*i),ctx.quadraticCurveTo(t+-.45*i,e+-1.3*i,t+-.06*i,e+-1.06*i),ctx.quadraticCurveTo(t+.85*i,e+-1.04*i,t+1.03*i,e+-.02*i),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#212219",ctx.beginPath(),ctx.ellipse(t+i/2.5+.05*i,e+5*i/13.5,3*i/23.5*1.1,5.85*i/23.5*1.1,0,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.ellipse(t-i/2.5,e-5*i/23.5+-.15*i,3*i/23.5*1.1,5.85*i/23.5*1.1,0,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.save(),ctx.beginPath(),ctx.ellipse(t+i/2.5+.05*i,e+5*i/13.5,2.5*i/23.5*1.1,5*i/23.5*1.1,0,0,2*Math.PI),ctx.clip(),ctx.fillStyle="#eeeeee",ctx.beginPath(),ctx.ellipse(t+i/2.5+.05*i,e+5*i/13.5,2.92*i/23.5*1.1,2.92*i/23.5*1.1,0,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.restore(),ctx.save(),ctx.beginPath(),ctx.ellipse(t-i/2.5,e-5*i/23.5+-.15*i,2.5*i/23.5*1.1,5*i/23.5*1.1,0,0,2*Math.PI),ctx.clip(),ctx.fillStyle="#eeeeee",ctx.beginPath(),ctx.ellipse(t-i/2.5,e-5*i/23.5+-.15*i,3*i/23.5*1.1,3*i/23.5*1.1,0,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.restore(),ctx.strokeStyle=ctx.fillStyle,ctx.lineWidth=i/15,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(t-.3*i+i/4,e+.025*i+9.5*i/23.5),ctx.quadraticCurveTo(t-.4*i,e-.1*i+1.07*i*5.5/23.5*61.1/70,t-.275*i-i/4,e-.25*i+9.5*i/23.5),ctx.stroke()}drawNodeIcon(t,e,i){ctx.fillStyle="#ffffff",ctx.strokeStyle="rgba(0, 0, 0, 0.3)",ctx.lineWidth=1,ctx.textAlign="center",ctx.textBaseline="middle",t.id.includes("hp")||t.id.includes("Hp")?(ctx.font="900 14px Ubuntu",ctx.fillText("â¤",e,i)):t.id.includes("damage")||t.id.includes("Damage")||t.id.includes("dps")?(ctx.font="900 14px Ubuntu",ctx.fillText("âš”",e,i)):t.id.includes("cooldown")||t.id.includes("cd")?(ctx.save(),ctx.translate(e,i),ctx.setLineDash([2,2]),ctx.beginPath(),ctx.arc(0,0,6,.7*Math.PI,2.3*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,9,1.2*Math.PI,1.8*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,6,1.8*Math.PI,2.2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,6,0*Math.PI,.4*Math.PI),ctx.stroke(),ctx.setLineDash([]),ctx.restore()):t.id.includes("range")?(ctx.save(),ctx.translate(e,i),ctx.setLineDash([3,3]),ctx.lineWidth=1,ctx.beginPath(),ctx.arc(0,0,8,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,5,0,2*Math.PI),ctx.stroke(),ctx.setLineDash([]),ctx.restore()):t.id.includes("knockback")?(ctx.font="900 14px Ubuntu",ctx.fillText("â†”",e,i)):t.id.includes("mass")?(ctx.font="900 14px Ubuntu",ctx.fillText("ðŸ”",e,i)):t.id.includes("heal")||t.id.includes("Heal")?(ctx.font="900 14px Ubuntu",ctx.fillText("âœš",e,i)):t.id.includes("duration")?(ctx.font="900 14px Ubuntu",ctx.fillText("â±",e,i)):(ctx.font="900 14px Ubuntu",ctx.fillText("â—†",e,i))}drawTooltip(t){const{artifactType:e,node:i,pos:a}=t;if(i.isRoot)return;const s=this.getNodeLevel(e,i.id),l=s>=i.maxLevel,o=this.canUpgradeNode(e,i.id),r=22.5,n=10,c=this.formatDescription(i.description);ctx.font="900 27px Ubuntu";const x=ctx.measureText(i.name).width;ctx.font=`900 ${.7*22.5}px Ubuntu`;let h=0;for(const t of c)if(Array.isArray(t)){let e=0;for(const i of t)e+=ctx.measureText(i.text).width;h=Math.max(h,e)}else h=Math.max(h,ctx.measureText(t).width);let d=Math.max(x,h);if(i.statKey){const t=this.formatStatName(i.statKey),e=i.statKey.includes("Multiplier")?"+x per level":"+0 per level";d=Math.max(d,ctx.measureText(t+": "+e).width)}const f=l?"MAXED":"Need SP to upgrade";d=Math.max(d,ctx.measureText(f).width);let u=40;u+=c.length*r,i.statKey&&(u+=r),u+=r,u+=n;const g=Math.max(200,d+20),p=u,v=a.x+this.skillTreeRenderOffset.x,m=a.y+this.skillTreeRenderOffset.y;let P=v+a.radius+15,y=m-p/2;P+g>this.w&&(P=v-a.radius-g-15),P<0&&(P=10),y<140&&(y=145),y+p>this.h&&(y=this.h-p-10),ctx.save(),ctx.fillStyle="#000000",ctx.globalAlpha=.5,ctx.beginPath(),ctx.roundRect(P,y,g,p,5),ctx.fill(),ctx.closePath(),ctx.globalAlpha=1,ctx.font="900 27px Ubuntu",ctx.lineWidth=3.9,ctx.textAlign="left",ctx.textBaseline="top",ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.strokeText(i.name,P+n,y+10),ctx.fillText(i.name,P+n,y+10);let S=y+40;ctx.font=`900 ${.7*22.5}px Ubuntu`,ctx.lineWidth=2.275;for(const t of c){if(Array.isArray(t)){let e=0;for(const i of t)ctx.fillStyle=i.color,ctx.strokeStyle="#000000",ctx.strokeText(i.text,P+n+e,S),ctx.fillText(i.text,P+n+e,S),e+=ctx.measureText(i.text).width}else ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.strokeText(t,P+n,S),ctx.fillText(t,P+n,S);S+=r}if(i.statKey){let t,e="#ffffff";t=i.statKey.includes("Multiplier")?`+${i.valuePerLevel.toFixed(2)}x per level`:"cooldown"===i.statKey?i.valuePerLevel<0?`${i.valuePerLevel.toFixed(1)}s per level`:`+${i.valuePerLevel.toFixed(1)}s per level`:"range"===i.statKey?`+${i.valuePerLevel.toFixed(0)}px per level`:"knockbackForce"===i.statKey?`+${i.valuePerLevel.toFixed(2)}x per level`:`+${i.valuePerLevel.toFixed(2)} per level`;const a=this.getStatColor(i.statKey),s=this.formatStatName(i.statKey);ctx.fillStyle=a,ctx.strokeStyle="#000000",ctx.strokeText(s+": ",P+n,S),ctx.fillText(s+": ",P+n,S);const l=ctx.measureText(s+": ").width;ctx.fillStyle=e,ctx.strokeText(t,P+n+l,S),ctx.fillText(t,P+n+l,S),S+=r}if(ctx.font=`900 ${.7*22.5}px Ubuntu`,ctx.lineWidth=2.275,l?(ctx.fillStyle="#32cd32",ctx.strokeStyle="#000000",ctx.strokeText("MAXED",P+n,S),ctx.fillText("MAXED",P+n,S)):this.isNodeUnlocked(e,i.id)?o?(ctx.fillStyle="#ffd700",ctx.strokeStyle="#000000",ctx.strokeText(`${i.costPerLevel} SP to upgrade`,P+n,S),ctx.fillText(`${i.costPerLevel} SP to upgrade`,P+n,S)):(ctx.fillStyle="#ff6b6b",ctx.strokeStyle="#000000",ctx.strokeText(`Need ${i.costPerLevel} SP`,P+n,S),ctx.fillText(`Need ${i.costPerLevel} SP`,P+n,S)):(ctx.fillStyle="#888888",ctx.strokeStyle="#000000",ctx.strokeText("Requires previous skills",P+n,S),ctx.fillText("Requires previous skills",P+n,S)),s>0&&!l){const t=l?"MAXED":`${i.costPerLevel} SP to upgrade`,e=` (${s}/${i.maxLevel})`;ctx.fillStyle="#ffffff",ctx.strokeText(e,P+n+ctx.measureText(t).width,S),ctx.fillText(e,P+n+ctx.measureText(t).width,S)}ctx.restore()}formatDescription(t){if(ctx.font=`900 ${.7*22.5}px Ubuntu`,Array.isArray(t))return[t];const e=[];let i="";const a=t.split("");for(const t of a){const a=i+t;ctx.measureText(a).width>260&&""!==i?(e.push(i),i=t):i=a}return i&&e.push(i),e.length>0?e:[t]}formatStatName(t){return{eggHpMultiplier:"Egg HP",eggMassMultiplier:"Egg Mass",eggDamageMultiplier:"Egg Damage",healMultiplier:"Heal",dpsMultiplier:"DPS",hpMultiplier:"HP",cooldown:"Cooldown",duration:"Duration",range:"Range",knockbackForce:"Knockback",damageMultiplier:"Frenzy Damage",healBoost:"Raid Heal"}[t]||t}getStatColor(t){return{eggHpMultiplier:"#ff9999",eggMassMultiplier:"#99ccff",eggDamageMultiplier:"#ff6666",healMultiplier:"#99ff99",dpsMultiplier:"#ff6666",hpMultiplier:"#ff9999",cooldown:"#ffcc66",duration:"#ccccff",range:"#99ccff",knockbackForce:"#ff9966",damageMultiplier:"#ff6666",healBoost:"#99ff99"}[t]||"#ffffff"}drawArtifactTooltip(t,e,i){const a=SKILL_TREES[t],s=this.artifacts[t];if(!a||!s)return;const l=s?.skillLevels||{},o=this.formatDescription(a.description),r=10,n={};for(const t of a.nodes){if(t.isRoot||!t.statKey)continue;const e=t.id.replace(/_\d+$/,"");n[e]||(n[e]={statKey:t.statKey,baseValue:t.baseValue,valuePerLevel:t.valuePerLevel,totalLevels:0,displayName:t.name})}for(const[t,e]of Object.entries(l)){const i=t.replace(/_\d+$/,"");n[i]&&(n[i].totalLevels+=e)}let c=[];for(const[t,e]of Object.entries(n)){if(0===e.totalLevels&&0===e.baseValue)continue;const t=e.baseValue+e.totalLevels*e.valuePerLevel,i={key:this.stripRomanNumeral(e.displayName),value:t,format:this.getValueFormat(e.statKey)};c.push(i)}a.passiveEffects?.squadHealShare&&c.push({key:"Squad Heal",value:100*a.passiveEffects.squadHealShare,format:"percent"}),ctx.font="900 27px Ubuntu";const x=ctx.measureText(a.name).width;ctx.font=`900 ${.7*22.5}px Ubuntu`;const h=Math.max(...o.map(t=>ctx.measureText(t).width));let d=0;for(const t of c){const e=this.formatStatValue(t);d=Math.max(d,ctx.measureText(e).width)}const f=Math.max(x+20,Math.max(h+20,d+20)),u=75+22.5*o.length+22.5*c.length+10;let g=e+45,p=i-u/2;g+f>this.w&&(g=e-45-f),g<0&&(g=10),p<0&&(p=10),p+u>this.h&&(p=this.h-u-10),ctx.save(),ctx.fillStyle="#000000",ctx.globalAlpha*=.5,ctx.beginPath(),ctx.roundRect(g,p,f,u,5),ctx.fill(),ctx.globalAlpha/=.5,ctx.font="900 27px Ubuntu",ctx.fillStyle=a.color,ctx.textAlign="left",ctx.textBaseline="top",ctx.strokeText(a.name,g+r,p+10),ctx.fillText(a.name,g+r,p+10),ctx.font=`900 ${.7*22.5}px Ubuntu`,ctx.fillStyle="#ffffff";let v=p+50;for(const t of o)ctx.strokeText(t,g+r,v),ctx.fillText(t,g+r,v),v+=22.5;let m=v+5;for(const t of c){const e=this.formatStatValue(t);ctx.fillStyle=a.color,ctx.strokeText(e,g+r,m),ctx.fillText(e,g+r,m),m+=22.5}ctx.restore()}stripRomanNumeral(t){return t.replace(/\s+[IVX]+$/,"")}getValueFormat(t){return t?.includes("Multiplier")||"healMultiplier"===t||"dpsMultiplier"===t||"hpMultiplier"===t?"multiplier":"cooldownReduction"===t?"negative_percent":"cooldown"===t?"time":"number"}formatStatValue(t){let e;switch(t.format){case"multiplier":e="x"+t.value.toFixed(2);break;case"percent":e=t.value.toFixed(0)+"%";break;case"negative_percent":e="-"+t.value.toFixed(0)+"%";break;case"time":e=t.value.toFixed(1)+"s";break;default:e=t.value.toFixed(2)}return`${t.key}: ${e}`}drawCloseButton(t,e){const i=30,a=this.w-i-10;t>a&&t<a+i&&e>10&&e<40?(ctx.fillStyle="#ff6b6b",setCursor("pointer"),this.hoveringOverX=!0):(ctx.fillStyle="#c1565e",this.hoveringOverX=!1),ctx.strokeStyle="#90464b",ctx.lineWidth=5,ctx.beginPath(),ctx.roundRect(a,10,i,i,6),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.lineWidth=4.75,ctx.lineCap="round",ctx.strokeStyle="#cccccc",ctx.beginPath(),ctx.moveTo(a+8,18),ctx.lineTo(a+i-8,32),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(a+i-8,18),ctx.lineTo(a+8,32),ctx.stroke(),ctx.closePath()}drawResetButton(t,e,i){const a=this.w-100-10,s=this.artifacts[i],l=s&&s.totalLevelPoints>0,o=432e5,r=Date.now(),n=this.lastArtifactResetTime||0,c=(n>0?r-n:o)<o;t>a&&t<a+100&&e>145&&e<175?(l&&!c?(ctx.fillStyle="#90ee90",setCursor("pointer")):ctx.fillStyle="#888888",this.hoveringOverReset=!0):(ctx.fillStyle=l&&!c?"#6aa8df":"#666666",this.hoveringOverReset=!1),ctx.strokeStyle=l&&!c?"#4981b1":"#555555",ctx.lineWidth=3,ctx.beginPath(),ctx.roundRect(a,145,100,30,5),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.font="700 14px Ubuntu",ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.textAlign="center",ctx.textBaseline="middle";const x=c?"Cooldown":"Reset";ctx.strokeText(x,a+50,160),ctx.fillText(x,a+50,160)}mouseMove(){if(this.menuActive&&this.isDraggingSkillTree){const t=mouse.x-this.dragStartPos.x,e=mouse.y-this.dragStartPos.y;this.skillTreeOffset.x+=t,this.skillTreeOffset.y+=e,this.dragStartPos={x:mouse.x,y:mouse.y},setCursor("grabbing")}}mouseUp(){this.isDraggingSkillTree=!1}mouseDown(){if(!this.menuActive)return;const t=mouse.canvasX-this.x,e=mouse.canvasY-this.y,i=this.w-30-10;if(t>i&&t<i+30&&e>10&&e<40)return void this.toggleMenu();if(this.selectedArtifactIndex>=0&&this.hoveringOverReset){const t=ARTIFACT_TYPES[this.selectedArtifactIndex];return void this.resetArtifactSkills(t)}const a=65*ARTIFACT_TYPES.length+10*(ARTIFACT_TYPES.length-1),s=(this.w-a)/2;for(let t=0;t<ARTIFACT_TYPES.length;t++){const e=ARTIFACT_TYPES[t],i=this.artifacts[e],a=s+75*t+32.5,l=97.5;if(mouse.canvasX>this.x+a-32.5&&mouse.canvasX<this.x+a+32.5&&mouse.canvasY>this.y+l-32.5&&mouse.canvasY<this.y+l+32.5){if(i.petalContainer&&i.petalContainer.amount>0){const t={petals:i.petalContainer.petals,type:i.petalContainer.type,rarity:i.petalContainer.rarity,id:i.petalContainer.id,amount:1};i.petalContainer.amount=0,i.renderPetalContainer.amount=0,draggingPetalContainer=new PetalContainer(t.petals,{...i.petalContainer,isDragging:!0},t.id||`${e}_artifact`,1);const s=Object.values(i.skillLevels).reduce((t,e)=>t+e,0)-1;return s>0&&(draggingPetalContainer.rarity=Math.min(s,34)),draggingPetalContainer.x=this.x+a,draggingPetalContainer.y=this.y+l,draggingPetalContainer.render.x=this.x+a,draggingPetalContainer.render.y=this.y+l,draggingPetalContainer.amount=1,draggingPetalContainer.mouseOffset={x:0,y:0},draggingPetalContainer.w=85,draggingPetalContainer.h=85,void(draggingPetalContainer.spawnAnimation=1)}return this.selectedArtifactIndex=t,this.nodePositions={},this.calculateNodePositions(ARTIFACT_TYPES[t]),this.skillTreeOffset={x:0,y:0},void(this.skillTreeRenderOffset={x:0,y:0})}}if(this.selectedArtifactIndex>=0&&this.hoveredNode){const{artifactType:t,node:e}=this.hoveredNode;return void(e.isRoot||this.upgradeNode(t,e.id))}this.selectedArtifactIndex>=0&&e>130&&(this.isDraggingSkillTree=!0,this.dragStartPos={x:mouse.x,y:mouse.y})}}