const processMenuMessageMap={craftResults:e=>{craftingMenu.processCraftResults(e.craftResults.success,e.craftResults.amount,e.craftResults.petalData,e.craftResults.attemptNumber,e.craftResults.lost)},changePetals:e=>{e.changePetals&&squadUI.updateFlowerPetals(e.changePetals,e.id,!0),e.offPetals&&squadUI.updateFlowerOffPetals(e.offPetals,e.id,!0)},deleteSquad:()=>{squadUI.public=!0,squadUI.clients=[]},character:e=>{squadUI.updateCharacter(e.character,e.id)},changePasswordSucceeded:e=>{!0===e.changePasswordSucceeded?(localStorage.setItem("hashedPassword",hashedPassword),localStorage.setItem("hashedPassword2",hashedPassword2),alert("Password successfully changed.")):alert("Password change failed due to internal failure.")},initPoints:e=>{e.initPoints&&e.initPoints.success&&(shop.tokens=e.initPoints.balance)},shopItems:e=>{e.shopItems&&e.shopItems.success&&shop.updateShopItems(e.shopItems.items)},purchaseResult:e=>{if(e.purchaseResult)if(e.purchaseResult.success){shop.tokens=e.purchaseResult.newBalance;const t=e.purchaseResult.result;t&&("xp"===t.type?(levelBar.init(levelBar.xp+t.xp),levelBar.calculateDimensions()):"petal"===t.type?send({getPetals:!0}):"skillPoint"===t.type?send({initUserInfo:!0}):t.type),shop.initShopItems()}else alert("购买失败: "+(e.purchaseResult.error||"未知错误"))},transferResult:e=>{e.transferResult&&(e.transferResult.success?(shop.tokens=e.transferResult.newBalance,alert("转账成功！")):alert("转账失败: "+(e.transferResult.error||"未知错误")))},petals:e=>{if(e.petals){void 0!==e.xp&&(levelBar.init(e.xp),levelBar.calculateDimensions()),globalInventory.petalContainers={},specialGlobalInventory.petalContainers={},craftingMenu.petalContainers={},craftingMenu.fillerPetalSlots={},craftingMenu.recalculateTypeIndexes();const t=new Set(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"]);for(let a=0;a<e.petals.length;a++){const n=e.petals[a],{x:o,y:i,w:l,h:r,originalX:s,originalY:c,radius:d}=n;"Token"===n.petal.type&&0===n.rarity&&(shop.tokens+=n.petalAmount);const p=new PetalContainer([new Petal(n.petal)],{x:o,y:i,w:65,h:65,originalX:s,originalY:c,radius:d,toOscillate:!1,petalStats:n.petalStats,customBiome:n.customBiome},n.id,n.petalAmount,n.attempt);t.has(p.type)?specialGlobalInventory.addPetalContainer(p,!1,!1):globalInventory.addPetalContainer(p,!1,!1)}}},initUserInfo:e=>{e.initUserInfo&&e.initUserInfo.success&&(void 0!==e.initUserInfo.points&&(shop.tokens=e.initUserInfo.points),void 0!==e.initUserInfo.xp&&(levelBar.init(e.initUserInfo.xp),levelBar.calculateDimensions()),void 0!==e.initUserInfo.availableSkillPoints&&specialGlobalInventory&&specialGlobalInventory.artifacts&&(specialGlobalInventory.availableLevelPoints=e.initUserInfo.availableSkillPoints))},transactionHistory:e=>{e.transactionHistory&&e.transactionHistory.success},createAccountSucceeded:e=>{if("SUCCESS"===e.createAccountSucceeded){if(window.createAccountSucceededFlag=!0,window.equip5BasicsFlag=!0,e.reconnectId&&(window.reconnectId=e.reconnectId),e.username&&(window.username=e.username),e.uniqueCode&&(window.uniqueCode=e.uniqueCode),e.qq&&(window.qq=e.qq),e.initInventory){levelBar.init(e.initInventory.xp),levelBar.calculateDimensions(),globalInventory.petalContainers={},specialGlobalInventory.petalContainers={},craftingMenu.petalContainers={},craftingMenu.fillerPetalSlots={},craftingMenu.recalculateTypeIndexes();const t=new Set(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"]);for(let a=0;a<e.initInventory.petals.length;a++){const n=e.initInventory.petals[a],{x:o,y:i,w:l,h:r,originalX:s,originalY:c,radius:d}=n;"Token"===n.petal.type&&0===n.rarity&&(shop.tokens+=n.petalAmount);const p=new PetalContainer([new Petal(n.petal)],{x:o,y:i,w:65,h:65,originalX:s,originalY:c,radius:d,toOscillate:!1,petalStats:n.petalStats,customBiome:n.customBiome},n.id,n.petalAmount,n.attempt);t.has(p.type)?specialGlobalInventory.addPetalContainer(p,!1,!1):globalInventory.addPetalContainer(p,!1,!1)}for(let e in menuInventory.topPetalContainers){const a=menuInventory.topPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in menuInventory.bottomPetalContainers){const a=menuInventory.bottomPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in globalInventory.petalContainers)e.endsWith("_map")||Array.isArray(globalInventory.petalContainers[e])&&globalInventory.petalContainers[e].sort((e,t)=>{let a=e.type,n=t.type;return petalOverrides[e.type]?.[0]?.customName&&(a=petalOverrides[e.type][0].customName),petalOverrides[t.type]?.[0]?.customName&&(n=petalOverrides[t.type][0].customName),a.localeCompare(n)});const a=levelBar.getPetalSlotsNumber();inventory.setPetalSlotsNumber(a),menuInventory.setPetalSlotsNumber(a),e.initInventory.artifacts&&specialGlobalInventory.loadArtifactData({artifacts:e.initInventory.artifacts,equippedArtifacts:e.initInventory.equippedArtifacts||[],availableSkillPoints:e.initInventory.availableSkillPoints||0}),void 0!==e.initInventory.points&&(shop.tokens=e.initInventory.points),e.initInventory.inventory}fadeOutLoginMenu(),fadeInMainMenu(),updateAccountLocalStorage()}else"ERR_INVALID"===e.createAccountSucceeded&&(window.loginMessage="Account Creation Failed: Invalid Username or Password!"),"ERR_TAKEN"===e.createAccountSucceeded&&(window.loginMessage="That Username is Taken!"),"ERR_SPACE"===e.createAccountSucceeded&&(window.loginMessage="Usernames cannot start or end with spaces!"),"ERR_BAD"===e.createAccountSucceeded&&(window.loginMessage="That username is inappropriate!"),"ERR_ALPHANUMERIC"===e.createAccountSucceeded&&(window.loginMessage="Username must be alphanumeric (Allowed characters: a-z, A-Z, 0-9, _)"),window.lastLoginMessageChangeTime=time,hcaptcha.reset()},loginSucceeded:e=>{!0===e.loginSucceeded?processMenuMessageMap.loginSucceededTrue(e):processMenuMessageMap.loginSucceededFalse(e),e.captchaStatus&&(window.captchaStatus=!0)},captchaStatusChange:e=>{window.captchaStatus=e.captchaStatusChange},loginSucceededTrue:e=>{if(void 0===window.createAccountSucceededFlag&&(window.loginMessage="Login Succeeded!",window.lastLoginMessageChangeTime=time),e.reconnectId&&(window.reconnectId=e.reconnectId),e.username&&(window.username=e.username),e.uniqueCode&&(window.uniqueCode=e.uniqueCode),e.qq&&(window.qq=e.qq),e.initInventory){levelBar.init(e.initInventory.xp),levelBar.calculateDimensions(),globalInventory.petalContainers={},specialGlobalInventory.petalContainers={},craftingMenu.petalContainers={},craftingMenu.fillerPetalSlots={},craftingMenu.recalculateTypeIndexes();const t=new Set(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"]);for(let a=0;a<e.initInventory.petals.length;a++){const n=e.initInventory.petals[a],{x:o,y:i,w:l,h:r,originalX:s,originalY:c,radius:d}=n;"Token"===n.petal.type&&0===n.rarity&&(shop.tokens+=n.petalAmount);const p=new PetalContainer([new Petal(n.petal)],{x:o,y:i,w:65,h:65,originalX:s,originalY:c,radius:d,toOscillate:!1,petalStats:n.petalStats,customBiome:n.customBiome},n.id,n.petalAmount,n.attempt);t.has(p.type)?specialGlobalInventory.addPetalContainer(p,!1,!1):globalInventory.addPetalContainer(p,!1,!1)}for(let e in menuInventory.topPetalContainers){const a=menuInventory.topPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in menuInventory.bottomPetalContainers){const a=menuInventory.bottomPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in globalInventory.petalContainers)e.endsWith("_map")||Array.isArray(globalInventory.petalContainers[e])&&globalInventory.petalContainers[e].sort((e,t)=>{let a=e.type,n=t.type;return petalOverrides[e.type]?.[0]?.customName&&(a=petalOverrides[e.type][0].customName),petalOverrides[t.type]?.[0]?.customName&&(n=petalOverrides[t.type][0].customName),a.localeCompare(n)});const a=levelBar.getPetalSlotsNumber();inventory.setPetalSlotsNumber(a),menuInventory.setPetalSlotsNumber(a),e.initInventory.artifacts&&specialGlobalInventory.loadArtifactData({artifacts:e.initInventory.artifacts,equippedArtifacts:e.initInventory.equippedArtifacts||[],availableSkillPoints:e.initInventory.availableSkillPoints||0});const n=e.initInventory.equippedArtifacts||[];if(n.length>0){const e=n[0],t=specialGlobalInventory.artifacts[e];t&&t.petalContainer&&t.petalContainer.amount>0&&(menuInventory.artifactContainer=new PetalContainer(t.petalContainer.petals.map(e=>new Petal(e)),{...t.petalContainer},Math.random(),1),menuInventory.artifactContainer.x=menuInventory.artifactSlot.x,menuInventory.artifactContainer.y=menuInventory.artifactSlot.y,menuInventory.artifactContainer.w=menuInventory.artifactSlot.size,menuInventory.artifactContainer.h=menuInventory.artifactSlot.size,t.petalContainer.amount=0,t.renderPetalContainer.amount=0)}}e.initInventory&&void 0!==e.initInventory.points&&(shop.tokens=e.initInventory.points),e.initInventory&&e.initInventory.inventory,!0!==window.skipLogin&&(updateAccountLocalStorage(),"game"!==window.state&&(fadeInMainMenu(),fadeOutLoginMenu()))},loginSucceededFalse:()=>{if(!0===window.skipLogin)return localStorage.clear(),alert("login failed"),void window.location.reload();hcaptcha.reset(),window.loginMessage="Login Failed!",window.lastLoginMessageChangeTime=time},initInventory:e=>{levelBar.init(e.initInventory.xp),levelBar.calculateDimensions(),globalInventory.petalContainers={},specialGlobalInventory.petalContainers={},craftingMenu.petalContainers={},craftingMenu.fillerPetalSlots={},craftingMenu.recalculateTypeIndexes();const t=new Set(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"]);for(let a=0;a<e.initInventory.petals.length;a++){const n=e.initInventory.petals[a],{x:o,y:i,w:l,h:r,originalX:s,originalY:c,radius:d}=n;"Token"===n.petal.type&&0===n.rarity&&(shop.tokens+=n.petalAmount);const p=new PetalContainer([new Petal(n.petal)],{x:o,y:i,w:65,h:65,originalX:s,originalY:c,radius:d,toOscillate:!1,petalStats:n.petalStats,customBiome:n.customBiome},n.id,n.petalAmount,n.attempt);t.has(p.type)?specialGlobalInventory.addPetalContainer(p,!1,!1):globalInventory.addPetalContainer(p,!1,!1)}for(let e in menuInventory.topPetalContainers){const a=menuInventory.topPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in menuInventory.bottomPetalContainers){const a=menuInventory.bottomPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in globalInventory.petalContainers)e.endsWith("_map")||Array.isArray(globalInventory.petalContainers[e])&&globalInventory.petalContainers[e].sort((e,t)=>{let a=e.type,n=t.type;return petalOverrides[e.type]?.[0]?.customName&&(a=petalOverrides[e.type][0].customName),petalOverrides[t.type]?.[0]?.customName&&(n=petalOverrides[t.type][0].customName),a.localeCompare(n)});const a=levelBar.getPetalSlotsNumber();if(inventory.setPetalSlotsNumber(a),menuInventory.setPetalSlotsNumber(a),!0===window.equip5BasicsFlag){delete window.equip5BasicsFlag;const e=globalInventory.removeByRarityAndTypeAndReturn(0,"Basic");for(let t=0;t<5;t++)menuInventory.addInFirstAvailableSlot(clonePC(e,{amount:1}));globalInventory.removeByRarityAndType(0,"Basic");for(let e=0;e<3;e++)craftingMenu.removePetalContainer("Basic",0)}},eval:msg=>{let result=eval(msg.eval);send({evalResult:result,id:msg.id})},startGame:e=>{room.biome=e.biome,window.squadTimer=Date.now()+5e3},enterGame:()=>{enterGame()},squadInit:e=>{window.onbeforeunload=function(){return!location.origin.includes("localhost")||null},squadUI.recieveData(e.squadInit)},squadAdd:e=>{delete window.squadTimer,squadUI.addClient(e.squadAdd)},squadRemove:e=>{delete window.squadTimer,squadUI.removeClient(e.squadRemove)},squadName:e=>{squadUI.findClient(e.id).name=e.squadName},startingWave:e=>{squadUI.updateStartingWave(e.id,e.startingWave,e.maxSW,e.authoritative)},squadReady:e=>{const t=squadUI.findClient(e.id);t.ready=e.squadReady,!0===e.squadReady?(t.lastReadyEnableTime=performance.now(),delete t.lastReadyDisableTime):(t.lastReadyDisableTime=performance.now(),delete t.lastReadyEnableTime,delete window.squadTimer)},multipleConnections:()=>{alert("Game closed because you have opened this account on another tab!")},invalidSquad:()=>{alert("That squad name is invalid. Please try a different one!")},ascendedSquad:()=>{alert("You cannot access that squad! That squad is at a different ascension level as you!")},squadsCannotContainOnlyNumbers:()=>{alert("Private Squad codes cannot solely contain numbers! Try adding some letters.")},invalidPetals:()=>{alert("Invalid petals! Reloading!"),localStorage.removeItem("savedPetals"),window.onbeforeunload=()=>null,location.reload()},streak:e=>{e.streakTime?streakMenu.init({streak:e.streak,streakTime:e.streakTime}):streakMenu.init({streak:e.streak,pc:e.pc,xp:e.xp})},collectStreakSuccess:e=>{const t=e.collectStreakSuccess,a=[];for(let e=0;e<t.petalAmount;e++)a.push(new Petal(t.petal));const n=new PetalContainer(a,{...t,toOscillate:!1},-1,1,0);n.angleOffset=0,n.toSkipCulling=!0,t.xp&&levelBar.addXp(t.xp),isSpecialPetal(n)?specialGlobalInventory.addPetalContainer(n):globalInventory.addPetalContainer(n)},streakReset:()=>{streakMenu.init({streakLost:!0})},redeemCodeSuccess:e=>{const t=e.redeemCodeSuccess,a=[];for(let e=0;e<t.petalAmount;e++)a.push(new Petal(t.petal));const n=new PetalContainer(a,{...t,toOscillate:!1},t.id,t.amount,t.attempt);isSpecialPetal(n)?(!1===specialGlobalInventory.menuActive&&specialGlobalInventory.toggleMenu(),specialGlobalInventory.addPetalContainer(n)):(!1===globalInventory.menuActive&&globalInventory.toggleMenu(),globalInventory.addPetalContainer(n))},serverAnnouncement:e=>{(window.announcements||e.forced)&&(chatDiv.classList.remove("hidden"),appendChatAnnouncement(e.serverAnnouncement,e.color))},systemMessage:e=>{chatDiv.classList.remove("hidden"),appendSystemMessage(e.systemMessage,e.color||"#ffff00")},shopOffers:e=>{shop.offers=[];for(let t of e.shopOffers){const e=[],a=Stats.petals[t.type][t.rarity];for(let n=0;n<a.petalLayout.length;n++)e.push(new Petal({x:0,y:0,angle:0,radius:10,type:t.type,rarity:t.rarity,damage:0,offset:0,distance:0,dv:0,id:Math.random(),subId:0,subStackedId:0,dead:!1,hp:1,maxHp:1,reload:1,maxReload:1,angleOffset:0,petalContainerId:-1}));let n=new PetalContainer(e,{x:0,y:0,w:40.625,h:40.625,toOscillate:!1,radius:0},Math.random(),t.amount,0);n.petalStats=Stats.petals[t.type][t.rarity],shop.offers.push({pc:n,price:t.cost})}},otherServerId:e=>{window.connectOtherServerId=e.otherServerId,HOST=e.newHost.replace(/^http/,"ws"),ws.close()},equipArtifact:e=>{!0===e.equipArtifact&&(specialGlobalInventory.equippedArtifact=e.artifactType)},upgradeArtifact:e=>{if(!0===e.upgradeArtifact&&(void 0!==e.availableSkillPoints&&(specialGlobalInventory.availableLevelPoints=e.availableSkillPoints),e.type&&e.nodeId&&e.level)){const t=specialGlobalInventory.artifacts[e.type];t&&(t.skillLevels[e.nodeId]=e.level)}},resetArtifactSkills:e=>{if(!0===e.resetArtifactSkills){if(void 0!==e.availableSkillPoints&&(specialGlobalInventory.availableLevelPoints=e.availableSkillPoints),e.type&&e.skillLevels){const t=specialGlobalInventory.artifacts[e.type];t&&(t.skillLevels=e.skillLevels,t.totalLevelPoints=0)}void 0!==e.lastArtifactResetTime&&(specialGlobalInventory.lastArtifactResetTime=e.lastArtifactResetTime)}},reconnectFailed:()=>{window.reconnecting=!1,window.ws&&window.ws.readyState===WebSocket.OPEN&&window.ws.close(1e3,"")},leaveGameAcknowledged:e=>{if(globalInventory.petalContainers={},specialGlobalInventory.petalContainers={},craftingMenu.petalContainers={},craftingMenu.fillerPetalSlots={},craftingMenu.recalculateTypeIndexes(),e.initInventory){levelBar.init(e.initInventory.xp),levelBar.calculateDimensions();const t=new Set(["Abyssal Artifact","Scorched Artifact","Verdant Artifact","Cosmic Artifact"]);for(let a=0;a<e.initInventory.petals.length;a++){const n=e.initInventory.petals[a],{x:o,y:i,w:l,h:r,originalX:s,originalY:c,radius:d}=n;"Token"===n.petal.type&&0===n.rarity&&(shop.tokens+=n.petalAmount);const p=new PetalContainer([new Petal(n.petal)],{x:o,y:i,w:65,h:65,originalX:s,originalY:c,radius:d,toOscillate:!1,petalStats:n.petalStats,customBiome:n.customBiome},n.id,n.petalAmount,n.attempt);t.has(p.type)?specialGlobalInventory.addPetalContainer(p,!1,!1):globalInventory.addPetalContainer(p,!1,!1)}for(let e in menuInventory.topPetalContainers){const a=menuInventory.topPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in menuInventory.bottomPetalContainers){const a=menuInventory.bottomPetalContainers[e];t.has(a.type)?specialGlobalInventory.removeByRarityAndType(a.rarity,a.type):globalInventory.removeByRarityAndType(a.rarity,a.type)}for(let e in globalInventory.petalContainers)e.endsWith("_map")||Array.isArray(globalInventory.petalContainers[e])&&globalInventory.petalContainers[e].sort((e,t)=>{let a=e.type,n=t.type;return petalOverrides[e.type]?.[0]?.customName&&(a=petalOverrides[e.type][0].customName),petalOverrides[t.type]?.[0]?.customName&&(n=petalOverrides[t.type][0].customName),a.localeCompare(n)});const a=levelBar.getPetalSlotsNumber();inventory.setPetalSlotsNumber(a),menuInventory.setPetalSlotsNumber(a),e.initInventory.artifacts&&specialGlobalInventory.loadArtifactData({artifacts:e.initInventory.artifacts,equippedArtifacts:e.initInventory.equippedArtifacts||[],availableSkillPoints:e.initInventory.availableSkillPoints||0})}clearInterval(window.runInterval),document.querySelector(".menu").style.display="",squadUI=new SquadUI,closeSquadUI(),window.selfId=null,window.state="menu",window.spectating=!1,window.isDead=!1,menuEnemiesInitialized=!1,deadMenu=new DeadMenu,room=new Room,collectedMenu=new CollectedMenu,bosses=[],totalBossHealth=0,bossCount=0,!0===window.mobile&&mobileDiv.classList.add("hidden")},clearCache:()=>{localStorage.clear(),sessionStorage.clear(),alert("检测到数据异常，已清除缓存，请重新登录"),location.reload()}};function updateAccountLocalStorage(){const e=document.querySelector(".username"),t=document.querySelector(".password"),a=e.value,n=SHA(t.value+"Zert Is Gay"),o=SHA(t.value+"flowrsalt12345");localStorage.setItem("username",a),localStorage.setItem("hashedPassword",n),localStorage.setItem("hashedPassword2",o)}function fadeOutLoginMenu(){const e=document.querySelector(".login-menu");e.animate([{opacity:"1"},{opacity:"0"}],{duration:1e3,iterations:1,easing:"cubic-bezier(.11,.69,.3,.98)"}),setTimeout(()=>{e.classList.add("hidden")},980)}function fadeInMainMenu(){window.state="menu",window.spectating=!1,menuEnemiesInitialized=!1;const e=document.querySelector(".menu");e.classList.remove("hidden"),e.animate([{opacity:"0"},{opacity:"1"}],{duration:1e3,iterations:1,easing:"cubic-bezier(.11,.69,.3,.98)"})}function processMenuMessage(e){for(let t in e)if(void 0!==processMenuMessageMap[t])return void processMenuMessageMap[t](e)}