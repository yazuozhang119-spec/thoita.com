function calculateChance(t,i){if(0==i){let i=30+9*t;return t>6&&(i+=(t-6)**2/2,i>100&&(i=100)),i}if(1==i){let i=15+1.5*t;return t>12&&(i+=(t-12)**2/2),i>100&&(i=100),i}if(2==i){let i=8+t/1.4;return t>18&&(i+=(t-18)**2/5),i>100&&(i=100),i}if(3==i){let i=5+t/5.6;return t>35&&(i+=(t-35)**2/5),i>100&&(i=100),i}if(4==i){let i=3+t/22.5;return t>60&&(i+=(t-60)**2/5),i>100&&(i=100),i}if(5==i){let i=2+t/33;return t>70&&(i+=(t-70)**2/5),i>100&&(i=100),i}if(6==i){let i=1+t/43;return t>95&&(i+=(t-95)**2/5),i>100&&(i=100),i}if(7==i){let i=.9+t/45;return t>95&&(i+=(t-95)**2/5),i>100&&(i=100),i}if(8==i){let i=.8+t/48;return t>95&&(i+=(t-95)**2/5),i>100&&(i=100),i}if(9==i){let i=.7+t/51;return t>100&&(i+=(t-100)**2/5),i>100&&(i=100),i}if(10==i){let i=.6+t/53;return t>105&&(i+=(t-105)**2/5),i>100&&(i=100),i}if(11==i){let i=.5+t/55;return t>110&&(i+=(t-110)**2/5),i>100&&(i=100),i}if(12==i){let i=0;return i=t<=9?.1+t/9*.4:t<=200?.5+(t-10)/190*1:1.5+(t-200)**2/10,i>100&&(i=100),i}if(13==i){let i=0;return i=t<=14?.08+t/14*.32:t<=240?.4+(t-15)/225*(1.4-.4):1.4+(t-240)**2/20,i>100&&(i=100),i}if(14==i){let i=0;return i=t<=14?.06+t/14*.24:t<=300?.3+(t-15)/285*.8:1.1+(t-300)**2/27,i>100&&(i=100),i}if(15==i){let i=0;return i=t<=20?.05+t/20*.2:t<=400?.25+(t-20)/380*.75:1+(t-400)**2/35,i>100&&(i=100),i}if(16==i){let i=0;return i=t<=20?.04+t/20*.16:t<=450?.2+(t-20)/430*.7:.9+(t-450)**2/50,i>100&&(i=100),i}if(17==i){let i=0;return i=t<=20?.03+t/20*.14:t<=500?.17+(t-20)/480*(.85-.17):.85+(t-500)**2/70,i>100&&(i=100),i}if(18==i){let i=0;return i=t<=20?.025+t/20*.125:t<=550?.15+(t-20)/530*.65:.8+(t-550)**2/85,i>100&&(i=100),i}if(19==i){let i=0;return i=t<=20?.02+t/20*(.14-.02):t<=600?.14+(t-20)/580*.61:.75+(t-600)**2/90,i>100&&(i=100),i}if(20==i){let i=0;return i=t<=20?.018+t/20*.112:t<=625?.13+(t-20)/605*.59:.72+(t-625)**2/100,i>100&&(i=100),i}if(21==i){let i=0;return i=t<=25?.016+t/20*.104:t<=650?.12+(t-20)/630*.58:.7+(t-650)**2/100,i>100&&(i=100),i}}class CraftingMenu{constructor(){this.state="crafting",this.icon=null,this.hoveringOverButton=!1,this.hoveringOverX=!1,this.menuActive=!1,this.petalContainers={},this.fillerPetalSlots={},this.w=445,this.h=665,this.scroll=0,this.horizontalScroll=0,this.render={scroll:this.scroll,horizontalScroll:this.horizontalScroll},this.totalPetalHeight=0,this.craftingPetalSlotsDimensions={x:.3*this.w,y:.24*this.h,maxRadius:88,radius:88,angleOffset:0},this.craftingPetalSlots=[];for(let t=0;t<5;t++){const i=2*Math.PI*t/5-Math.PI/2;this.craftingPetalSlots.push({x:this.craftingPetalSlotsDimensions.x+Math.cos(i)*this.craftingPetalSlotsDimensions.radius,y:this.craftingPetalSlotsDimensions.y+Math.sin(i)*this.craftingPetalSlotsDimensions.radius,w:65,h:65})}this.craftingPetalContainers=[],this.craftingAnimationState=!1,this.craftingAnimationTimer=0,this.craftingAnimationData={},this.hoveringOverCraftButton=!1,this.lastClickedPc={time:0,type:"Basic",rarity:0,amount:0},this.craftingButton={x:.83*this.w,y:.28*this.h,w:.16*this.w,h:.11*this.w},this.inventorySpace={x:6,y:.48*this.h,w:this.w-10-24,h:.52*this.h-4},this.scrollbar={top:0,bottom:0,renderTop:0,renderBottom:0,length:75,start:this.inventorySpace.y+52.5,end:this.inventorySpace.y+this.inventorySpace.h-52.5},this.horizontalScrollBar={left:0,right:0,renderLeft:0,renderRight:0,length:75,start:this.inventorySpace.x+52.5,end:this.inventorySpace.x+this.inventorySpace.w-52.5},this.draggingScrollBar=!1,this.draggingHorizontalScrollBar=!1,this.typeIndex=0,this.typeIndexes={},this.petalContainerSize=57.4,this.maxRarity=0,this.fadingPetalContainers=[],this.rainingPetalSlots=[],this.isRainingPetalSlots=!1,this.hoveringOverScrollBar=!1,this.hoveringOverHorizontalScrollBar=!1}enterGame(){this.craftingPetalContainers=[],this.craftingAnimationState=!1,this.craftingAnimationTimer=0,this.craftingAnimationData={}}addPetalContainer(t){(showCommunityBiomes||petalRenderMap[t.type])&&(isSpecialPetal(t)||(void 0===this.petalContainers[t.type]&&(this.petalContainers[t.type]={},this.typeIndexes[t.type]=this.typeIndex++,this.recalculateTypeIndexes()),void 0!==this.petalContainers[t.type][t.rarity]?(this.petalContainers[t.type][t.rarity].amount+=t.amount,this.petalContainers[t.type][t.rarity].lastAmountChangedTime=time,null!=t.attempt&&(this.petalContainers[t.type][t.rarity].attempt=t.attempt)):(this.petalContainers[t.type][t.rarity]=t,this.petalContainers[t.type][t.rarity].w=this.petalContainerSize,this.petalContainers[t.type][t.rarity].h=this.petalContainerSize,null!=t.attempt&&(this.petalContainers[t.type][t.rarity].attempt=t.attempt)),t.rarity>this.maxRarity&&(this.maxRarity=t.rarity,this.maxRarity>5&&(this.inventorySpace.h=.52*this.h-4-24))))}removePetalContainer(t,i){void 0!==this.petalContainers[t][i]&&this.petalContainers[t][i].amount>=2?(this.petalContainers[t][i].amount--,this.petalContainers[t][i].lastAmountChangedTime=time):delete this.petalContainers[t][i]}removePetalContainerAmount(t,i,e){void 0!==this.petalContainers[t][i]&&this.petalContainers[t][i].amount>=e+1?(this.petalContainers[t][i].amount-=e,this.petalContainers[t][i].lastAmountChangedTime=time):delete this.petalContainers[t][i]}recalculateTypeIndexes(){this.typeIndexes={},this.typeIndex=0;for(let t of Object.keys(this.petalContainers).sort((t,i)=>(petalOverrides[t]?.[0]?.customName&&(t=petalOverrides[t][0].customName),petalOverrides[i]?.[0]?.customName&&(i=petalOverrides[i][0].customName),t.localeCompare(i))))this.typeIndexes[t]=this.typeIndex++}draw(){let t=!0===this.fadingOut?1-(time-this.originalFadeOutTime)/100:1;!0===this.menuActive||time-this.lastCloseTime<160?this.drawInventory(t):this.hoveringOverX=!1}getMainStroke(){let t="#986c40";return"forge"==this.state&&(t="#5b2971"),t}getMainFill(){let t="#da9b5b";return"forge"==this.state&&(t="#6f328a"),t}getHoverFill(){let t="#dea56b";return"forge"==this.state&&(t="#88569f"),t}getSlotColor(){let t="#b17f49";return"forge"==this.state&&(t="#652d7d"),t}drawIcon(){ctx.lineWidth=6,ctx.fillStyle=this.getMainFill(),ctx.strokeStyle=this.getMainStroke(),ctx.translate(0,-100),mouse.canvasX+6>20&&mouse.canvasY+6>canvas.h-20-80-100&&mouse.canvasX-6<100&&mouse.canvasY-6<canvas.h-20-80+80-100?(ctx.fillStyle=this.getHoverFill(),setCursor("pointer"),this.hoveringOverButton=!0):this.hoveringOverButton=!1,ctx.beginPath(),ctx.roundRect(20,canvas.h-20-80,80,80,3),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.font="900 30px Ubuntu",ctx.fillStyle="#ffffff",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.textAlign="center",ctx.textBaseline="middle";const t="crafting"===this.state?"ðŸ”¨":"âš’ï¸";ctx.strokeText(t,60,canvas.h-20-40),ctx.fillText(t,60,canvas.h-20-40),ctx.fillStyle="#f0f0f0",ctx.strokeStyle="black",ctx.lineWidth=2.25,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="900 14px Ubuntu";const i=ctx.letterSpacing;ctx.letterSpacing="0px",ctx.strokeText("[C]",82.5,canvas.h-20-80+15),ctx.fillText("[C]",82.5,canvas.h-20-80+15),ctx.letterSpacing=i,ctx.translate(0,100),!0===this.isRainingPetalSlots&&this.renderRainPetalSlots()}toggleMenu(){!0===mobGallery.menuActive&&mobGallery.toggleMenu(),!0===this.menuActive?this.lastCloseTime=time:(this.lastOpenTime=time,!0===globalInventory.menuActive&&globalInventory.toggleMenu(),!0===specialGlobalInventory.menuActive&&specialGlobalInventory.toggleMenu()),this.menuActive=!this.menuActive}drawInventory(t=1){this.render.scroll=interpolate(this.render.scroll,this.scroll,.007*dt),1!==t&&(ctx.globalAlpha=t);let i=0;time-this.lastCloseTime<160&&(i+=this.h*easeOutCubic((time-this.lastCloseTime)/160)),time-this.lastOpenTime<160&&(i+=this.h+40-(this.h+40)*easeOutCubic((time-this.lastOpenTime)/160)),0!==i&&ctx.translate(0,i),ctx.translate(130,canvas.h-this.h-20),ctx.fillStyle=this.getMainFill(),ctx.strokeStyle=this.getMainStroke(),ctx.lineWidth=8,ctx.beginPath(),ctx.roundRect(0,0,this.w,this.h,3),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#f0f0f0",ctx.strokeStyle="black",ctx.lineWidth=3.75,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="900 32px Ubuntu";let e="Craft";if("forge"==this.state&&(e="Forge"),ctx.strokeText(e,this.w/2,29),ctx.fillText(e,this.w/2,29),"crafting"==this.state){if(!0===this.craftingAnimationState&&this.runCraftingAnimation(),"display"===this.craftingAnimationState)this.displayPetalContainer.x=this.craftingPetalSlotsDimensions.x+.35*this.displayPetalContainer.render.w,this.displayPetalContainer.y=this.craftingPetalSlotsDimensions.y+.35*this.displayPetalContainer.render.h,this.displayPetalContainer.render.x=this.displayPetalContainer.x,this.displayPetalContainer.render.y=this.displayPetalContainer.y,this.displayPetalContainer.draw();else for(let t=0;t<this.craftingPetalSlots.length;t++)if(ctx.fillStyle=this.getSlotColor(),ctx.beginPath(),ctx.roundRect(this.craftingPetalSlots[t].x,this.craftingPetalSlots[t].y,this.craftingPetalSlots[t].w,this.craftingPetalSlots[t].h,8),ctx.fill(),ctx.closePath(),void 0!==this.craftingPetalContainers[t]){const i=this.craftingPetalContainers[t];i.x=this.craftingPetalSlots[t].x+this.craftingPetalSlots[t].w/2,i.y=this.craftingPetalSlots[t].y+this.craftingPetalSlots[t].h/2,i.draw()}}else{if(ctx.fillStyle=this.getSlotColor(),ctx.beginPath(),ctx.roundRect(.1*this.w,this.craftingButton.y-36.25,72.5,72.5,8),ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.roundRect(.275*this.w+50,this.craftingButton.y-50,100,100,8),ctx.fill(),ctx.closePath(),void 0!==this.craftingPetalContainers[0]){const t=this.craftingPetalContainers[0];t.x=.1*this.w+t.render.w/2+3.75,t.y=this.craftingButton.y-36.25+t.render.w/2+3.75,t.draw()}for(let t=1;t<=this.craftingPetalContainers.length-1;t++)if(void 0!==this.craftingPetalContainers[t]){const i=this.craftingPetalContainers[t];i.w=50,i.x=.275*this.w+75+i.render.w/2+25*Math.cos((t-1)/(this.craftingPetalContainers.length-1)*Math.PI*2),i.y=this.craftingButton.y-25+i.render.w/2+25*Math.sin((t-1)/(this.craftingPetalContainers.length-1)*Math.PI*2),i.draw()}}!0===mouseInBox({x:mouse.canvasX,y:mouse.canvasY},{x:this.craftingButton.x-this.craftingButton.w/2+130,y:this.craftingButton.y-this.craftingButton.h/2+canvas.h-this.h-20,w:this.craftingButton.w,h:this.craftingButton.h})&&!1===this.craftingAnimationState?this.hoveringOverCraftButton=!0:this.hoveringOverCraftButton=!1,ctx.letterSpacing="0px";let a="#777777",n="#555555";if("crafting"==this.state?void 0!==this.craftingPetalContainers[0]&&Colors.rarities[this.craftingPetalContainers[0].rarity+1]&&(a=Colors.rarities[this.craftingPetalContainers[0].rarity+1].color,n=Colors.rarities[this.craftingPetalContainers[0].rarity+1].border,this.hoveringOverCraftButton&&(a=blendColor(a,"#ffffff",.1),n=blendColor(n,"#ffffff",.03))):void 0!==this.craftingPetalContainers[1]&&Colors.rarities[this.craftingPetalContainers[0].rarity+1]&&(a=Colors.rarities[this.craftingPetalContainers[0].rarity+1].color,n=Colors.rarities[this.craftingPetalContainers[0].rarity+1].border,this.hoveringOverCraftButton&&(a=blendColor(a,"#ffffff",.1),n=blendColor(n,"#ffffff",.03))),ctx.lineWidth=7,ctx.fillStyle=a,ctx.strokeStyle=n,ctx.beginPath(),ctx.roundRect(this.craftingButton.x-this.craftingButton.w/2,this.craftingButton.y-this.craftingButton.h/2,this.craftingButton.w,this.craftingButton.h,4),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#f0f0f0",ctx.strokeStyle="black",ctx.lineWidth=2.25,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="900 22px Ubuntu",ctx.strokeText(e,this.craftingButton.x,this.craftingButton.y),ctx.fillText(e,this.craftingButton.x,this.craftingButton.y),"crafting"==this.state&&this.craftingPetalContainers[0]){ctx.fillStyle="#f0f0f0",ctx.strokeStyle="black",ctx.lineWidth=2.25,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="900 12px Ubuntu";let t=this.craftingPetalContainers[0].attempt;null==t&&(t=0);let i=calculateChance(t,this.craftingPetalContainers[0].rarity);this.craftingAnimationTimer>3e3&&this.craftingAnimationData.successAmount>0?(ctx.fillStyle="#00ff00",ctx.strokeText("Success (-"+this.craftingAnimationData.lost+")",this.craftingButton.x,this.craftingButton.y+40),ctx.fillText("Success (-"+this.craftingAnimationData.lost+")",this.craftingButton.x,this.craftingButton.y+40)):(ctx.strokeText("Attempt "+(t+1),this.craftingButton.x,this.craftingButton.y+60),ctx.fillText("Attempt "+(t+1),this.craftingButton.x,this.craftingButton.y+60),this.craftingPetalContainers[0].rarity>=16?(ctx.strokeText(Math.floor(1e4*i)/1e4+"% success chance",this.craftingButton.x,this.craftingButton.y+40),ctx.fillText(Math.floor(1e4*i)/1e4+"% success chance",this.craftingButton.x,this.craftingButton.y+40)):this.craftingPetalContainers[0].rarity>=12?(ctx.strokeText(Math.floor(100*i)/100+"% success chance",this.craftingButton.x,this.craftingButton.y+40),ctx.fillText(Math.floor(100*i)/100+"% success chance",this.craftingButton.x,this.craftingButton.y+40)):(ctx.strokeText(Math.floor(10*i)/10+"% success chance",this.craftingButton.x,this.craftingButton.y+40),ctx.fillText(Math.floor(10*i)/10+"% success chance",this.craftingButton.x,this.craftingButton.y+40)))}!0!==this.hoveringOverCraftButton&&!0!==this.draggingHorizontalScrollBar&&!0!==this.draggingScrollBar&&!0!==this.hoveringOverHorizontalScrollBar&&!0!==this.hoveringOverScrollBar||setCursor("pointer"),ctx.save(),ctx.beginPath(),ctx.rect(this.inventorySpace.x,this.inventorySpace.y,this.fillingHorizontal?this.inventorySpace.w+24:this.inventorySpace.w,this.inventorySpace.h),ctx.clip(),ctx.closePath(),this.firstPetalContainer=null,this.lastPetalContainer=null;const r=this.petalContainerSize/2+this.inventorySpace.x+0*(this.petalContainerSize+12)+3,s=this.petalContainerSize/2+this.inventorySpace.x+(this.petalContainerSize+12)*this.maxRarity-6;this.totalPetalWidth=s-r;let l=0;for(let t in this.petalContainers)for(let i=0;i<=Math.max(5,this.maxRarity);i++){const e=i,a=this.petalContainerSize/2+this.inventorySpace.x+(this.petalContainerSize+12)*e+3-this.render.horizontalScroll*(this.totalPetalWidth-this.inventorySpace.h),n=5+this.petalContainerSize/2+this.typeIndexes[t]*(this.petalContainerSize+12)+5+this.inventorySpace.y-this.render.scroll*(this.totalPetalHeight-this.inventorySpace.h);this.typeIndexes[t]>l&&(l=this.typeIndexes[t]),void 0===this.fillerPetalSlots[t]&&(this.fillerPetalSlots[t]={}),void 0===this.fillerPetalSlots[t][e]&&(this.fillerPetalSlots[t][e]={render:{x:a,y:n}});const r=this.fillerPetalSlots[t][e];if(r.x=a,r.y=n,r.render.x=interpolate(r.render.x,r.x,.00672*dt),r.render.y=interpolate(r.render.y,r.y,.00672*dt),ctx.fillStyle=this.getSlotColor(),void 0===this.petalContainers[t][e]&&r.render.x+this.petalContainerSize/2>.9*this.inventorySpace.x&&r.render.x+this.petalContainerSize/2<1.2*(this.inventorySpace.x+this.inventorySpace.w)&&r.render.y+this.petalContainerSize/2>.9*this.inventorySpace.y&&r.render.y+this.petalContainerSize/2<1.1*(this.inventorySpace.y+this.inventorySpace.h)&&(ctx.beginPath(),ctx.roundRect(r.render.x-this.petalContainerSize/2,r.render.y-this.petalContainerSize/2,this.petalContainerSize,this.petalContainerSize,8),ctx.fill(),ctx.closePath()),void 0!==this.petalContainers[t]&&void 0!==this.petalContainers[t][e]){const i=this.petalContainers[t][e];i.x=a,i.y=n,i.render.x+i.w/2>.9*this.inventorySpace.x&&i.render.x-i.w/2<1.1*(this.inventorySpace.x+this.inventorySpace.w)&&i.render.y+i.w/2>.9*this.inventorySpace.y&&i.render.y-i.w/2<1.1*(this.inventorySpace.y+this.inventorySpace.h)?i.draw():(i.render.x=interpolate(i.render.x,i.x,.00672*dt),i.render.y=interpolate(i.render.y,i.y,.00672*dt)),0===this.typeIndexes[t]&&(this.firstPetalContainer=i),this.typeIndexes[t]===this.typeIndex-1&&(this.lastPetalContainer=i)}else 0===this.typeIndexes[t]&&(this.firstPetalContainer=r),this.typeIndexes[t]===this.typeIndex-1&&(this.lastPetalContainer=r)}if(Object.keys(this.petalContainers).length<5){this.fillingHorizontal=!0;for(let t=Object.keys(this.petalContainers).length;t<5;t++){const i="filler"+t;for(let e=0;e<=Math.max(5,this.maxRarity);e++){const a=e,n=this.petalContainerSize/2+this.inventorySpace.x+(this.petalContainerSize+12)*a+3-this.render.horizontalScroll*(this.totalPetalWidth-this.inventorySpace.h),r=5+this.petalContainerSize/2+(l+t-Object.keys(this.petalContainers).length+1)*(this.petalContainerSize+12)+5+this.inventorySpace.y-this.render.scroll*(this.totalPetalHeight-this.inventorySpace.h);void 0===this.fillerPetalSlots[i]&&(this.fillerPetalSlots[i]={}),void 0===this.fillerPetalSlots[i][a]&&(this.fillerPetalSlots[i][a]={render:{x:n,y:r}});const s=this.fillerPetalSlots[i][a];s.x=n,s.y=r,s.render.x=interpolate(s.render.x,s.x,.00672*dt),s.render.y=interpolate(s.render.y,s.y,.00672*dt),ctx.fillStyle=this.getSlotColor(),ctx.beginPath(),ctx.roundRect(s.render.x-this.petalContainerSize/2,s.render.y-this.petalContainerSize/2,this.petalContainerSize,this.petalContainerSize,8),ctx.fill(),ctx.closePath()}}}else this.fillingHorizontal=!1;if(null!==this.lastPetalContainer){const t={start:this.firstPetalContainer.y-this.petalContainerSize/2-6,end:this.lastPetalContainer.y+this.petalContainerSize/2+6};t.length=t.end-t.start,this.totalPetalHeight=t.length}ctx.restore();let o=!1;for(let t=0;t<this.fadingPetalContainers.length;t++)this.fadingPetalContainers[t].spawnTime<.001&&(this.fadingPetalContainers[t].toRemove=!0,o=!0),this.fadingPetalContainers[t].draw();!0===o&&(this.fadingPetalContainers=this.fadingPetalContainers.filter(t=>!0!==t.toRemove)),!1===this.fillingHorizontal&&(this.render.scroll=interpolate(this.render.scroll,this.scroll,.007*dt),this.render.scroll<-.1?this.render.scroll=-.1:this.render.scroll>1.1&&(this.render.scroll=1.1),this.scrollbar.pos=interpolate(this.scrollbar.start,this.scrollbar.end,this.render.scroll),this.scrollbar.bottom=this.scrollbar.pos+this.scrollbar.length/2,this.scrollbar.top=this.scrollbar.pos-this.scrollbar.length/2,this.scrollbar.renderTop=interpolate(this.scrollbar.renderTop,this.scrollbar.top,this.draggingScrollBar?.28:.08),this.scrollbar.renderBottom=interpolate(this.scrollbar.renderBottom,this.scrollbar.bottom,this.draggingScrollBar?.28:.08)),this.maxRarity>=5&&(this.render.horizontalScroll=interpolate(this.render.horizontalScroll,this.horizontalScroll,.007*dt),this.horizontalScrollBar.pos=interpolate(this.horizontalScrollBar.start,this.horizontalScrollBar.end,this.render.horizontalScroll),this.horizontalScrollBar.right=this.horizontalScrollBar.pos+this.horizontalScrollBar.length/2,this.horizontalScrollBar.left=this.horizontalScrollBar.pos-this.horizontalScrollBar.length/2,this.horizontalScrollBar.renderRight=interpolate(this.horizontalScrollBar.renderRight,this.horizontalScrollBar.right,this.draggingHorizontalScrollBar?.28:.08),this.horizontalScrollBar.renderLeft=interpolate(this.horizontalScrollBar.renderLeft,this.horizontalScrollBar.left,this.draggingHorizontalScrollBar?.28:.08)),this.scroll<0?this.scroll=0:this.scroll>1&&(this.scroll=1),ctx.strokeStyle=this.getMainStroke(),ctx.lineWidth=8,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(this.w-16,this.scrollbar.renderTop),ctx.lineTo(this.w-16,this.scrollbar.renderBottom),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(this.horizontalScrollBar.renderRight,this.h-16),ctx.lineTo(this.horizontalScrollBar.renderLeft,this.h-16),ctx.stroke(),ctx.closePath(),!0===this.menuActive&&0===i?mouse.canvasX>130+this.w-7.5-30-3&&mouse.canvasY>canvas.h-this.h-20+7.5+3&&mouse.canvasX<130+this.w-7.5-3&&mouse.canvasY<canvas.h-this.h-20+7.5+30+3?(ctx.fillStyle="#c16666",setCursor("pointer"),this.hoveringOverX=!0):(this.hoveringOverX=!1,ctx.fillStyle="#c1565e"):(ctx.fillStyle="#c1565e",this.hoveringOverX=!1),ctx.translate(-3,3),ctx.strokeStyle="#90464b",ctx.lineWidth=5,ctx.beginPath(),ctx.roundRect(this.w-7.5-30,7.5,30,30,6),ctx.fill(),ctx.stroke(),ctx.closePath(),ctx.lineWidth=4.75,ctx.lineCap="round",ctx.strokeStyle="#cccccc",ctx.beginPath(),ctx.moveTo(this.w-30,30),ctx.lineTo(this.w-15,15),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(this.w-15,30),ctx.lineTo(this.w-30,15),ctx.stroke(),ctx.closePath(),ctx.translate(3,-3);const h=mouse.x*canvas.w/window.innerWidth,c=mouse.y*canvas.h/window.innerHeight;if(ctx.translate(-130,-(canvas.h-this.h-20)),0!==i&&ctx.translate(0,-i),ctx.globalAlpha=1,h>130&&h<130+this.w-20&&c>canvas.h-this.h-20&&c<canvas.h-20){for(let t in this.petalContainers)for(let i=0;i<=this.maxRarity;i++){if(void 0===this.petalContainers[t])continue;const e=i,a=this.petalContainers[t][e];void 0!==a&&a.render.x+a.w/2>.9*this.inventorySpace.x&&a.render.x-a.w/2<1.1*(this.inventorySpace.x+this.inventorySpace.w)&&a.render.y+a.w/2>.9*this.inventorySpace.y&&a.render.y-a.w/2<1.1*(this.inventorySpace.y+this.inventorySpace.h)&&(!0===mouseInBox({x:h,y:c},{x:a.render.x-a.w/2+130,y:a.render.y-a.h/2+canvas.h-this.h-20,w:a.w,h:a.h})&&(a.isHovered=!0),a.drawStatsBox(!1,!1,130+a.render.x,canvas.h-this.h-20+a.render.y))}if("display"===this.craftingAnimationState){const t=this.displayPetalContainer;!0===mouseInBox({x:h,y:c},{x:t.render.x-t.w/2+130,y:t.render.y-t.h/2+canvas.h-this.h-20,w:t.w,h:t.h})&&(t.isHovered=!0),t.drawStatsBox(!1,!1,130+t.render.x,canvas.h-this.h-20+t.render.y)}else for(let t=0;t<this.craftingPetalSlots.length;t++)if(void 0!==this.craftingPetalContainers[t]){const i=this.craftingPetalContainers[t];!0===mouseInBox({x:h,y:c},{x:i.render.x-i.w/2+130,y:i.render.y-i.h/2+canvas.h-this.h-20,w:i.w,h:i.h})&&(i.isHovered=!0),i.drawStatsBox(!1,!1,130+i.render.x,canvas.h-this.h-20+i.render.y)}}}updateScroll({x:t,y:i},{mouseX:e,mouseY:a}){if(!0!==this.menuActive||0===Object.keys(this.petalContainers).length||!0===this.fillingHorizontal)return;if(e<130||a<canvas.h-this.h-20||e>130+this.w||a>canvas.h-20)return;const n={start:this.firstPetalContainer.y-this.petalContainerSize/2-6,end:this.lastPetalContainer.y+this.petalContainerSize/2+6};n.length=n.end-n.start,this.scroll+=i/n.length}mouseDown({mouseX:t,mouseY:i},e){if(t>130+this.w-24&&t<130+this.w-24+16&&i>this.scrollbar.top+canvas.h-this.h-20&&i<this.scrollbar.top+canvas.h-this.h-20+this.scrollbar.length?this.draggingScrollBar=!0:this.maxRarity>=5&&t>130+this.horizontalScrollBar.left&&t<130+this.horizontalScrollBar.left+this.horizontalScrollBar.length&&i>canvas.h-this.h-20+this.h-16-16&&i<canvas.h-this.h-20+this.h-16+16&&(this.draggingHorizontalScrollBar=!0),"display"!==this.craftingAnimationState){if(!0!==this.craftingAnimationState){if(!0===this.hoveringOverCraftButton&&5===this.craftingPetalContainers.length){if(this.craftingPetalContainers[0]&&"Token"==this.craftingPetalContainers[0].type)return;let t=0;for(let i of this.craftingPetalContainers)t+=i.amount;return(this.state="crafting")?send({craft:!0,type:this.craftingPetalContainers[4].type,rarity:this.craftingPetalContainers[4].rarity,amount:t}):send({forge:!0,pcs:this.craftingPetalContainers}),this.finishedCraft=!1,void this.startCraftingAnimation()}for(let e=0;e<this.craftingPetalContainers.length;e++){const a=this.craftingPetalContainers[e];!0===mouseInBox({x:t,y:i},{x:a.x-a.w/2+130,y:a.y-a.h/2+canvas.h-this.h-20,w:a.w,h:a.h})&&this.removeCraftingPetalContainers()}if(!0===mouseInBox({x:t,y:i},{x:this.inventorySpace.x+130,y:this.inventorySpace.y-this.h-20+canvas.h,w:this.inventorySpace.w,h:this.inventorySpace.h})&&!1===this.craftingAnimationState)for(let a in this.petalContainers)for(let n in this.petalContainers[a]){const r=this.petalContainers[a][n];if(t>r.x-r.w/2+130&&t<130+r.x+r.w/2&&i>r.y-r.h/2+canvas.h-this.h-20&&i<r.y+r.h/2+canvas.h-this.h-20){(this.lastClickedPc.time+1e3<Date.now()||this.lastClickedPc.type!==a||this.lastClickedPc.rarity!==n)&&(this.lastClickedPc.amount=0);let t=5*1.6**this.lastClickedPc.amount;this.craftingPetalContainers[0]||"forge"!=this.state||(t=1),this.addCraftingPetalContainers(a,n,Math.floor(!0===e.shiftKey?r.amount:Math.min(r.amount,t)),r.attempt),this.lastClickedPc={time:Date.now(),type:a,rarity:n,amount:this.lastClickedPc.amount+1}}}}}else!0===mouseInBox({x:this.mouseX,y:this.mouseY},{x:this.displayPetalContainer.x-this.displayPetalContainer.w/2+130,y:this.displayPetalContainer.y-this.displayPetalContainer.h/2+canvas.h-this.h-20,w:this.displayPetalContainer.w,h:this.displayPetalContainer.h})&&(this.displayPetalContainer.isDisplayPetalContainer=!1,this.displayPetalContainer.toOscillate=!1,this.displayPetalContainer.angleOffset=0,isSpecialPetal(this.displayPetalContainer)?specialGlobalInventory.addPetalContainer(this.displayPetalContainer):globalInventory.addPetalContainer(this.displayPetalContainer),this.addFadingPetalContainer(this.displayPetalContainer),delete this.displayPetalContainer,this.craftingAnimationState=!1,this.craftingAnimationData={})}addCraftingPetalContainers(t,i,e,a){if(("Basic"!==t||0!=i)&&"Token"!==t&&"display"!==this.craftingAnimationState)if("crafting"==this.state){const n=Math.floor(e/5),r=e-5*n,s=void 0!==this.craftingPetalContainers[0]?this.craftingPetalContainers[0].type:"NULL";if(0===n&&t!==s)for(let t=0;t<5;t++)if(!(r>t)&&void 0===this.craftingPetalContainers[t])return;let l=0;for(let t=0;t<this.craftingPetalContainers.length;t++)void 0!==this.craftingPetalContainers[t]&&l++;if(s!==t&&e<5)return;if(s===t&&l+e<5)return;const o=this.petalContainers[t][i];if(!this.craftingPetalContainers[0]||s!==t||(this.craftingPetalContainers[0]??{rarity:-1}).rarity!==i)for(let a=0;a<globalInventory.petalContainers[i].length;a++){const n=globalInventory.petalContainers[i][a];if(n.type===t){globalInventory.removePetalContainerAmount(n.rarity,a,e);break}}for(let e=0;e<5;e++)void 0!==this.craftingPetalContainers[e]?this.craftingPetalContainers[e].type===t&&this.craftingPetalContainers[e].rarity==i?this.craftingPetalContainers[e].amount+=n+(r>e):(globalInventory.addPetalContainer(this.craftingPetalContainers[e]),this.addFadingPetalContainer(this.craftingPetalContainers[e]),this.craftingPetalContainers[e]=new PetalContainer(o.petals,{...o,w:65,h:65},Math.random(),n+(r>e),a)):this.craftingPetalContainers[e]=new PetalContainer(o.petals,{...o,w:65,h:65},Math.random(),n+(r>e),a)}else{const n=this.petalContainers[t][i];if(void 0!==this.craftingPetalContainers[0]){let r=!1;for(let a=1;a<=this.craftingPetalContainers.length;a++)if(this.craftingPetalContainers[a]?.type==t&&this.craftingPetalContainers[a]?.rarity==i){this.craftingPetalContainers[a].amount+=e,r=!0;break}0==r&&this.craftingPetalContainers.push(new PetalContainer(n.petals,{...n,w:65,h:65},Math.random(),e,a))}else this.craftingPetalContainers[0]=new PetalContainer(n.petals,{...n,w:65,h:65},Math.random(),e,a);for(let a=0;a<globalInventory.petalContainers[i].length;a++){const n=globalInventory.petalContainers[i][a];if(n.type===t){globalInventory.removePetalContainerAmount(n.rarity,a,e);break}}}}removeCraftingPetalContainers(){if(0===this.craftingPetalContainers.length)return;for(let t=0;t<this.craftingPetalContainers.length;t++)this.addFadingPetalContainer(this.craftingPetalContainers[t]);let t=0;for(let i=0;i<this.craftingPetalContainers.length;i++)t+=this.craftingPetalContainers[i].amount;this.craftingPetalContainers[0].amount=t,globalInventory.addPetalContainer(this.craftingPetalContainers[0]),this.craftingPetalContainers=[]}startCraftingAnimation(){this.craftingAnimationState=!0,this.craftingAnimationTimer=0}runCraftingAnimation(){this.craftingAnimationTimer+=dt;for(let t=0;t<5;t++){const i=this.craftingAnimationTimer/150+2*Math.PI*t/5,e=this.craftingPetalSlotsDimensions.radius*Math.sin(this.craftingAnimationTimer/300);this.craftingPetalSlots[t].x=this.craftingPetalSlotsDimensions.x+Math.cos(i)*e,this.craftingPetalSlots[t].y=this.craftingPetalSlotsDimensions.y+Math.sin(i)*e,this.craftingPetalContainers[t].render.x=this.craftingPetalSlots[t].x+this.craftingPetalSlots[t].w/2,this.craftingPetalContainers[t].x=this.craftingPetalSlots[t].x+this.craftingPetalSlots[t].w/2,this.craftingPetalContainers[t].render.y=this.craftingPetalSlots[t].y+this.craftingPetalSlots[t].h/2,this.craftingPetalContainers[t].y=this.craftingPetalSlots[t].y+this.craftingPetalSlots[t].h/2}if(this.craftingAnimationTimer>3e3&&1==this.finishedCraft){if(this.craftingAnimationData.successAmount>0){this.craftingAnimationState="display",this.displayPetalContainer=new PetalContainer(new Array(this.craftingAnimationData.petalData.petalAmount).fill(new Petal(this.craftingAnimationData.petalData.petal)),{...this.craftingAnimationData.petalData,toOscillate:!0,w:65,h:65},Math.random(),this.craftingAnimationData.successAmount),this.startRainingPetalSlots(new PetalContainer(new Array(this.craftingAnimationData.petalData.petalAmount).fill(new Petal(this.craftingAnimationData.petalData.petal)),{...this.craftingAnimationData.petalData,toOscillate:!0,w:65,h:65},Math.random(),this.craftingAnimationData.successAmount)),this.displayPetalContainer.angleOffset/=3,this.displayPetalContainer.isDisplayPetalContainer=!0,this.displayPetalContainer.w=85,this.displayPetalContainer.h=85,this.displayPetalContainer.render.w=85,this.displayPetalContainer.render.h=85;for(let t=0;t<this.craftingPetalContainers.length;t++)t>=this.craftingAnimationData.amountRemaining?(this.craftingPetalContainers[t].toRemove=!0,this.craftingPetalContainers[t].attempt=this.craftingAnimationData.attempt):(this.craftingPetalContainers[t].amount=1,this.craftingPetalContainers[t].attempt=this.craftingAnimationData.attempt);this.petalContainers[this.craftingPetalContainers[0].type][this.craftingPetalContainers[0].rarity]&&(this.petalContainers[this.craftingPetalContainers[0].type][this.craftingPetalContainers[0].rarity].attempt=this.craftingAnimationData.attempt),this.craftingPetalContainers=this.craftingPetalContainers.filter(t=>!0!==t.toRemove)}else{this.craftingAnimationState=!1;for(let t=0;t<this.craftingPetalContainers.length;t++)t>=this.craftingAnimationData.amountRemaining?(this.addFadingPetalContainer(this.craftingPetalContainers[t]),this.craftingPetalContainers[t].toRemove=!0,this.craftingPetalContainers[t].attempt=this.craftingAnimationData.attempt):(this.craftingPetalContainers[t].amount=1,this.craftingPetalContainers[t].attempt=this.craftingAnimationData.attempt);this.craftingPetalContainers=this.craftingPetalContainers.filter(t=>!0!==t.toRemove)}this.craftingPetalSlots=[];for(let t=0;t<5;t++){const i=2*Math.PI*t/5-Math.PI/2;this.craftingPetalSlots.push({x:this.craftingPetalSlotsDimensions.x+Math.cos(i)*this.craftingPetalSlotsDimensions.radius,y:this.craftingPetalSlotsDimensions.y+Math.sin(i)*this.craftingPetalSlotsDimensions.radius,w:65,h:65})}}}processCraftResults(t,i,e,a,n){this.craftingAnimationData={successAmount:t,amountRemaining:i,petalData:e,attempt:a,lost:n},this.finishedCraft=!0}addFadingPetalContainer(t){this.fadingPetalContainers.push(new PetalContainer(t.petals.map(t=>new Petal(t)),{...t},Math.random(),t.amount)),this.fadingPetalContainers[this.fadingPetalContainers.length-1].collectTime=performance.now()}startRainingPetalSlots(t){if(0==window.petalRain)return;this.isRainingPetalSlots=!0;let i={0:{amount:3},1:{amount:7},2:{amount:15},3:{amount:30},4:{amount:56},5:{amount:82},6:{amount:120},7:{amount:200},8:{amount:200},9:{amount:200},10:{amount:200},11:{amount:200},12:{amount:200},13:{amount:200},14:{amount:200}}[t.rarity-1].amount*Math.ceil(Math.sqrt(t.amount));this.rainInterval=setInterval(()=>{if(i--,i<0)return clearInterval(this.rainInterval),void delete this.rainInterval;this.rainingPetalSlots.push(this.spawnRainPetalSlot(t))},10)}spawnRainPetalSlot(t){const i=new PetalContainer(t.petals.map(t=>new Petal(t)),{...t},Math.random(),t.amount);i.toOscillate=!0,i.toSkipCulling=!0,i.isDisplayPetalContainer=!0,i.renderAnimationTimer=0,i.y=canvas.h,i.render.y=i.y,i.x=canvas.w/2+(2*Math.random()-1)*canvas.w*.4,i.render.x=i.x,i.angleOffset=2*-Math.PI+(2*Math.random()-1)*Math.PI*.2,i.angleOffsetVel=Math.sqrt(.03*(2*Math.random()-1));const e=.5*Math.PI+(2*Math.random()-1)*Math.PI*.6;return i.xv=3*Math.cos(e),i.yv=10*-Math.sin(e),i}simulateRainPetalSlot(t){t.angleOffset+=t.angleOffsetVel,t.x+=t.xv,t.y+=t.yv,t.yv+=.03,t.y>canvas.height+t.w*Math.sqrt(2)&&t.yv>0&&(t.toRemove=!0)}renderRainPetalSlots(){for(let t=0;t<this.rainingPetalSlots.length;t++)this.rainingPetalSlots[t].draw(),this.simulateRainPetalSlot(this.rainingPetalSlots[t]);this.rainingPetalSlots=this.rainingPetalSlots.filter(t=>!0!==t.toRemove),0===this.rainingPetalSlots.length&&void 0===this.rainInterval&&(this.isRainingPetalSlots=!1)}mouseUp({mouseX:t,mouseY:i}){this.draggingScrollBar=!1,this.draggingHorizontalScrollBar=!1}mouseMove({mouseX:t,mouseY:i}){this.hoveringOverHorizontalScrollBar=!1,this.hoveringOverScrollBar=!1,!0===this.draggingScrollBar?(this.scroll=(i-(canvas.h-this.h-20)-this.scrollbar.start)/(this.scrollbar.end-this.scrollbar.start),this.scroll<0?this.scroll=0:this.scroll>1&&(this.scroll=1)):!0===this.draggingHorizontalScrollBar?(this.horizontalScroll=(t-130-this.horizontalScrollBar.start)/(this.horizontalScrollBar.end-this.horizontalScrollBar.start),this.horizontalScroll<0?this.horizontalScroll=0:this.horizontalScroll>1&&(this.horizontalScroll=1)):t>130+this.w-24&&t<130+this.w-24+16&&i>this.scrollbar.top+canvas.h-this.h-20&&i<this.scrollbar.top+canvas.h-this.h-20+this.scrollbar.length?this.hoveringOverScrollBar=!0:this.maxRarity>=5&&t>130+this.horizontalScrollBar.left&&t<130+this.horizontalScrollBar.left+this.horizontalScrollBar.length&&i>canvas.h-this.h-20+this.h-16-16&&i<canvas.h-this.h-20+this.h-16+16&&(this.hoveringOverHorizontalScrollBar=!0)}}function mouseInBox({x:t,y:i},e={x:t,y:i,w,h}){return!(t>e.x+e.w||i>e.y+e.h||t<e.x||i<e.y)}