let ver=document.scripts[0].src.split("v=")[1];ver||"localhost:8080"!=location.host||(ver="Developer");let ws,servers={"ws://localhost:8080/ws":"Local"};function initWS(){ws=new WebSocket(HOST),ws.binaryType="arraybuffer",ws.onopen=handleOpen,ws.onmessage=handleMessage,ws.onclose=handleClose}function startKeepAlive(){window.keepAlive=[setInterval(()=>{"game"!==window.state&&send({ping:!0})},2e4),setInterval(()=>{"game"==window.state&&!window.reconnecting&&performance.now()-window.lastMessageTimeReceived>5e3&&(ws.onopen=null,ws.onmessage=null,ws.onclose=null,ws.onerror=null,ws.close(1e3,"manual reconnection"),handleClose(),window.lastMessageTimeReceived=performance.now())},1e3)]}function stopKeepAlive(){window.keepAlive.forEach(e=>clearInterval(e))}function handleOpen(){if(startKeepAlive(),window.lastMessageTimeReceived=performance.now(),ws.onerror=()=>{},ws.binaryType="arraybuffer",window.connected=!0,window.connectedTime=window.time,document.querySelector(".grid").classList.add("show"),!0!==window.reconnecting||window.connectBackMainServ)window.connectBackMainServ&&(window.state="menu",delete window.connectBackMainServ),!0===window.skipLogin&&!0!==window.reconnecting&&send({login:{username,hashedPassword,hashedPassword2}});else{const e={reconnect:!0,id:window.reconnectId};void 0!==window.connectOtherServerId?(e.connectOtherServerId=window.connectOtherServerId,delete window.connectOtherServerId,window.state="menu"):window.state="game",setTimeout(()=>{ws.readyState===WebSocket.OPEN?(ws.send(msgpackr.pack(e)),wsMsgQueue=[],window.reconnecting=!1,window.reconnectTries=20,window.reconnectStartTime=null,setTimeout(sendQueuedMessages,100)):window.reconnecting=!1},50)}}function handleMessage(e){if(window.lastMessageTimeReceived=performance.now(),e.data.byteLength%4==0){const n=new Float32Array(e.data),t=n[0];if("function"==typeof processRawMessage[t])return void processRawMessage[t](n)}let n;try{n=msgpackr.unpack(e.data)}catch(e){return}"game"===window.state||"dead"===window.state?processGameMessage(n):processMenuMessage(n)}HOST="wss://thoita-prod-7gydki1s27ab5d0f-1398459068.ap-shanghai.run.wxcloudrun.com/ws",HOST="ws://localhost:8080/ws",HOST="wss://ws.thoita.com:17033/ws",window.state=null===localStorage.getItem("hashedPassword")?"account":"menu",window.skipLogin="account"!==window.state,window.connected=!1,window.spectating=!1,window.reconnectTries=20,window.reconnecting=!1,window.reconnectStartTime=null,window.lastMessageTimeReceived=performance.now(),window.keepAlive=[];let isHandlingClose=!1;function handleClose(e){if(!isHandlingClose){if(isHandlingClose=!0,stopKeepAlive(),delete window.connectedTime,window.state="disconnected",e&&e.reason&&""!=e.reason)return window.connected=!1,void(isHandlingClose=!1);if(["game","disconnected"].includes(window.state)||void 0!==window.connectOtherServerId)if(window.reconnectTries>0){if(checkReconnectTimeout())return void(isHandlingClose=!1);wsMsgQueue.length=0,send=e=>{wsMsgQueue.push(e)},window.reconnecting=!0,setTimeout(()=>{isHandlingClose=!1,attemptReconnect()},timeBetweenReconnects(window.reconnectTries))}else isHandlingClose=!1;else window.connected=!1,isHandlingClose=!1}}function attemptReconnect(){window.reconnectStartTime||(window.reconnectStartTime=Date.now()),initWS(),window.reconnectTries--}function timeBetweenReconnects(e){return 500+1e3*(20-e)}function checkReconnectTimeout(){return!!(window.reconnectStartTime&&Date.now()-window.reconnectStartTime>3e4)&&(window.reconnectTries=0,window.reconnecting=!1,window.reconnectStartTime=null,"undefined"!=typeof alert&&alert("连接已断开，请刷新页面重新连接"),!0)}initWS(),window.onload=()=>{resize(),document.querySelector(".loader").style.animation="fadeOut .2s",setTimeout(()=>{document.querySelector(".loader").remove()},200-1e3/60*2);for(let e=0;e<onLoadFunctions.length;e++)onLoadFunctions[e]();onLoadFunctions.length=0,window.loaded=!0,send=(e,n)=>{if((n||!window.reconnecting)&&ws.readyState===WebSocket.OPEN)try{ws.send(msgpackr.pack(e))}catch(e){}};for(let e=0;e<wsMsgQueue.length;e++)send(wsMsgQueue[e])};const playButton=document.querySelector(".play-btn"),playText=document.querySelector(".play-text");let lastAttempt=Date.now();playButton.onclick=()=>{if(biomeManager.getCurrentBiome(),"Exit "===playText.getAttribute("stroke"))closeSquadUI();else if("Ready"===playText.getAttribute("stroke"))changeReady(!window.ready);else{if(!window.connected)return;delete window.squadUICloseTime,window.squadUIEnabled=!0,playText.setAttribute("stroke","Exit "),playButton.classList.add("exit"),squadUI.initRenderTimer=0,squadUI.buttonAlpha=0,changeReady(!1)}};let wsMsgQueue=[],send=e=>{wsMsgQueue.push(e)};function sendQueuedMessages(){let e=setInterval(()=>{if(0==wsMsgQueue.length)return clearInterval(e),void(send=e=>{ws.send(msgpackr.pack(e))});ws.send(msgpackr.pack(wsMsgQueue.shift()))},100)}if(location.href.endsWith("/3d")){window.is3D=!0;const e=document.createElement("script");e.type="module",e.src="systems/3d.js",document.body.append(e)}window.simulateDisconnect=function(){ws&&ws.readyState===WebSocket.OPEN&&ws.close(1e3)},window.cancelReconnect=function(){window.reconnectTries=0},window.getReconnectStatus=function(){return{state:window.state,reconnecting:window.reconnecting,reconnectTries:window.reconnectTries,reconnectId:window.reconnectId,connected:window.connected,wsReadyState:ws?.readyState,wsReadyStateText:ws?.readyState===WebSocket.CONNECTING?"CONNECTING":ws?.readyState===WebSocket.OPEN?"OPEN":ws?.readyState===WebSocket.CLOSING?"CLOSING":ws?.readyState===WebSocket.CLOSED?"CLOSED":"UNKNOWN"}},window.sendLeaveGame=function(){send({leaveGame:!0,real:!0})};