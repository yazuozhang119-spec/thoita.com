const mouse={x:0,y:0,canvasX:0,canvasY:0,clickPosition:"up",lastDownData:{time:-1/0,x:0,y:0}},keyCodes={KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right"},directionToIdMap={up:0,left:1,down:2,right:3};function arrayEquals(t,e){return Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((t,n)=>t===e[n])}let latestInput=[],previousInput=null,lastSentInput=window.performance.now(),minimumInputTime=100;const chatCommandMap={};class InputHandler{constructor(t){this.client=t,this.chatOpen=!1}start(){window.onkeydown=t=>this.handleKey(t),window.onkeyup=t=>this.handleKey(t),window.onmousemove=t=>this.handleMouse(t),window.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("visibilitychange",()=>{if("hidden"===document.visibilityState)for(let t in this.input)this.input[t]=!1})}updateChat(){document.activeElement===chatInput?(!1===this.chatOpen&&(chatDiv.classList.remove("hidden"),chatInput.focus()),this.chatOpen=!0,chatInput.style.opacity="1"):(!0===this.chatOpen&&chatInput.blur(),this.chatOpen=!1,chatInput.style.opacity="0")}handleKey(t){if(void 0===t.code)return;if(this.updateChat(),"game"!==window.state)this.chatOpen=!1;else if("Enter"===t.code&&!0!==window.isEditor){if(!0===this.chatOpen&&"keydown"===t.type){const t=chatInput.value.trim();if(0!==t.length)if("/clear"==t){for(let t=0;t<chatDiv.children[1].children.length;t++)chatDiv.children[1].children.item(0).remove();chatDiv.children[1].children.item(0).remove()}else send(["c",t]);this.chatOpen=!1,chatInput.value="",chatInput.blur(),chatInput.style.opacity="0"}else if("keydown"===t.type){this.chatOpen=!0,chatDiv.classList.remove("hidden"),chatInput.focus(),chatInput.style.opacity="1",arrayEquals(latestInput,[0,0,0,0])||(latestInput=[0,0,0,0],send(latestInput));const e=room.flowers[window.selfId];!0===e.attacking&&(e.attacking=!1,send({attack:!1})),!0===e.defending?(e.defending=!1,send({defend:!1})):1==t.button&&send(["middle",!1])}return t.preventDefault()}if(t.repeat&&!1===this.chatOpen)return t.preventDefault();if(!0===this.chatOpen)return;if("KeyQ"===t.code&&"keydown"===t.type&&"INPUT"!==document.activeElement.tagName&&("game"==window.state?send({reduceRotateSpeed:!0}):menuInventory.speedCircle.mode=1),"KeyE"===t.code&&"keydown"===t.type&&"INPUT"!==document.activeElement.tagName&&("game"==window.state?send({increaseRotateSpeed:!0}):menuInventory.speedCircle.mode=2),"KeyQ"!==t.code&&"KeyE"!==t.code||"keyup"!==t.type||"INPUT"===document.activeElement.tagName||(menuInventory.speedCircle.mode=0,"game"==window.state?"KeyQ"===t.code?send({reduceRotateSpeed:!1}):send({increaseRotateSpeed:!1}):(send({speedCircle:menuInventory.speedCircle.reload}),localStorage.setItem("speedCircle",menuInventory.speedCircle.reload))),"Semicolon"===t.code&&!1===t.repeat&&"keydown"===t.type&&(window.toRenderDebug=!window.toRenderDebug,window.fps=0,window.framesRendered=0,window.lastFramesRenderedResetTime=performance.now()),!0===t.code.startsWith("Digit")&&!1===t.repeat&&"keydown"===t.type&&"INPUT"!==document.activeElement.tagName){const e="Digit0"===t.code?9:t.code[5]-1;if(void 0===e)return;"menu"===window.state?menuInventory.swapPetals(e):inventory.swapPetals(e)}else if("KeyR"===t.code&&!1===t.repeat&&"keydown"===t.type&&"INPUT"!==document.activeElement.tagName)for(let t=0;t<10;t++)inventory.swapPetals(t);const e=room.flowers[window.selfId];if(!0===window.connected&&void 0!==e){if(!mouseMovement&&keyCodes[t.code]){4!=latestInput.length&&(latestInput=[0,0,0,0]),"keydown"===t.type?latestInput[directionToIdMap[keyCodes[t.code]]]=1:latestInput[directionToIdMap[keyCodes[t.code]]]=0,arrayEquals(latestInput,previousInput)||(send(latestInput),previousInput=window.structuredClone(latestInput)),e.input[keyCodes[t.code]]="keydown"===t.type;let n=0,i=0;e.input.up&&(i-=1),e.input.down&&(i+=1),e.input.left&&(n-=1),e.input.right&&(n+=1);let a=Math.atan2(i,n);0==i&&0==n||(e.angle=a,e.magnitude=9999)}if(" "==t.key&&(send({attack:"keydown"===t.type}),room.flowers[window.selfId].attacking="keydown"===t.type),"Shift"==t.key&&(send({defend:"keydown"===t.type}),room.flowers[window.selfId].defending="keydown"===t.type),"f"==t.key&&(send({middle:"keydown"===t.type}),room.flowers[window.selfId].middleState="keydown"===t.type),"KeyG"===t.code&&"keydown"===t.type&&!t.repeat&&inventory&&inventory.artifactContainer){const t=inventory.artifactContainer.type;t&&send({activateArtifactUltimate:{artifactType:t}})}"["==t.key&&"keydown"===t.type&&(fov=1),"Equal"==t.code&&"keydown"===t.type&&(fov*=1.2,fov<.2&&(fov=.2),fov>3&&(fov=3)),"Minus"==t.code&&"keydown"===t.type&&(fov*=.8,fov<.2&&(fov=.2),fov>3&&(fov=3))}"menu"===window.state&&"keydown"===t.type&&"INPUT"!==document.activeElement.tagName&&("x"===t.key.toLowerCase()?globalInventory.toggleMenu():"c"===t.key.toLowerCase()?craftingMenu.toggleMenu():"v"===t.key.toLowerCase()?mobGallery.toggleMenu():"z"===t.key.toLowerCase()&&specialGlobalInventory.toggleMenu())}sendInitialInput(){if(mouseMovement){const t=mouse.x-window.innerWidth/2,e=mouse.y-window.innerHeight/2;let n=Math.sqrt(e**2+t**2);n<220&&(n=(n/220)**.9*220),2!=latestInput.length&&(latestInput=[0,0]);const i=Math.atan2(e,t);latestInput[0]=Math.round(1e3*i)/1e3,latestInput[1]=Math.round(10*n)/10,send(latestInput)}}handleMouse(t){const e=t.x-window.innerWidth/2,n=t.y-window.innerHeight/2,i=room.flowers[window.selfId];if(!0===window.connected&&void 0!==i&&mouseMovement)if(window.mobile)mobileControls.handleMouseMove(t);else{let t=Math.sqrt(n**2+e**2);if(t=t>=220?220:(t/220)**.9*220,i.angle=Math.atan2(n,e),i.magnitude=t,2!=latestInput.length&&(latestInput=[0,0]),latestInput[0]=Math.round(1e3*i.angle)/1e3,latestInput[1]=Math.round(10*t)/10,220===latestInput[1]&&(latestInput.length=1),!arrayEquals(latestInput,previousInput))if(time-lastSentInput>minimumInputTime)send(latestInput),previousInput=window.structuredClone(latestInput),lastSentInput=time;else{let t=lastSentInput,e=latestInput;setTimeout(()=>{t==lastSentInput&&(send(e),previousInput=window.structuredClone(e),lastSentInput=time)},minimumInputTime-(time-lastSentInput))}}if(mouse.x=t.pageX,mouse.y=t.pageY,mouse.canvasX=mouse.x/window.innerWidth*canvas.w,mouse.canvasY=mouse.y/window.innerHeight*canvas.h,"undefined"!=typeof draggingPetalContainer&&null!==draggingPetalContainer&&simulatedraggingPetalContainer(mouse.canvasX,mouse.canvasY),"menu"===window.state){const e=mouse.canvasX,n=mouse.canvasY;biomeManager.mouseMove({mouseX:e,mouseY:n},t);const i=void 0===t.button?0:t.button;"undefined"!=typeof squadUI&&!0===squadUI.hoveringOverSlider&&0===i&&!0===squadUI.draggingSlider&&squadUI.updateSliderDrag(mouse.canvasX),settingsMenu.mouseMove({x:e,y:n})}"undefined"!=typeof globalInventory&&(globalInventory.mouseMove({mouseX:mouse.canvasX,mouseY:mouse.canvasY}),craftingMenu.mouseMove({mouseX:mouse.canvasX,mouseY:mouse.canvasY}),mobGallery.mouseMove({x:mouse.canvasX,y:mouse.canvasY}),specialGlobalInventory.mouseMove())}}class MobileControls{constructor(){this.joystickpad={x:1*canvas.w/10,y:canvas.h-1*canvas.w/10,r:canvas.w/15},this.joystick={r:canvas.w/40,magnitude:0,angle:0},this.currentlyHolding=!1,this.attacking=!1,this.defending=!1,this.dynamicJoystickActive=!1,this.dynamicJoystickCenter={x:0,y:0},this.dynamicJoystickpad={x:0,y:0,r:canvas.w/15}}draw(){const t=room.flowers[window.selfId];if(!window.mobile||void 0===t||!0!==window.connected)return;const e=window.dynamicJoystick??!1;let n,i;this.joystickpad={x:1*canvas.w/10,y:canvas.h-1*canvas.w/10,r:canvas.w/15},this.joystick.r=canvas.w/40,e&&this.dynamicJoystickActive?(n=this.dynamicJoystickpad.x,i=this.dynamicJoystickpad.y):e?(n=null,i=null):(n=this.joystickpad.x,i=this.joystickpad.y),null!==n&&(ctx.globalAlpha=.2,ctx.fillStyle="#000000",ctx.beginPath(),ctx.arc(n,i,this.joystickpad.r,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1,this.joystick.dx=Math.cos(this.joystick.angle)*this.joystick.magnitude,this.joystick.dy=Math.sin(this.joystick.angle)*this.joystick.magnitude,ctx.globalAlpha=.5,ctx.fillStyle="#000000",ctx.beginPath(),ctx.arc(n+this.joystick.dx,i+this.joystick.dy,this.joystick.r,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1),this.attackButton={x:8.4*canvas.w/10,y:canvas.h-1.4*canvas.w/10,r:canvas.w/20},this.defendButton={x:9.3*canvas.w/10,y:canvas.h-.5*canvas.w/10,r:canvas.w/25},ctx.globalAlpha=.4,ctx.fillStyle="#000000",ctx.beginPath(),ctx.arc(this.attackButton.x,this.attackButton.y,this.attackButton.r,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1,ctx.globalAlpha=.4,ctx.fillStyle="#000000",ctx.beginPath(),ctx.arc(this.defendButton.x,this.defendButton.y,this.defendButton.r,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1,this.plusButton={x:8.6*canvas.w/10,y:canvas.h-.5*canvas.w/10,r:canvas.w/70},this.minusButton={x:8.2*canvas.w/10,y:canvas.h-.5*canvas.w/10,r:canvas.w/70},ctx.globalAlpha=.4,ctx.strokeStyle="#000000",ctx.beginPath(),ctx.moveTo(this.plusButton.x-this.plusButton.r,this.plusButton.y),ctx.lineTo(this.plusButton.x+this.plusButton.r,this.plusButton.y),ctx.moveTo(this.plusButton.x,this.plusButton.y-this.plusButton.r),ctx.lineTo(this.plusButton.x,this.plusButton.y+this.plusButton.r),ctx.lineWidth=15,ctx.stroke(),ctx.globalAlpha=1,ctx.globalAlpha=.4,ctx.strokeStyle="#000000",ctx.beginPath(),ctx.moveTo(this.minusButton.x-this.minusButton.r,this.minusButton.y),ctx.lineTo(this.minusButton.x+this.minusButton.r,this.minusButton.y),ctx.lineWidth=15,ctx.stroke(),ctx.globalAlpha=1,this.swapButton={x:9.3*canvas.w/10,y:canvas.h-1.3*canvas.w/10,r:canvas.w/40},ctx.globalAlpha=.4,ctx.fillStyle="#000000",ctx.beginPath(),ctx.arc(this.swapButton.x,this.swapButton.y,this.swapButton.r,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#ffffff",ctx.font="600 40px Ubuntu",ctx.fillText("R",this.swapButton.x,this.swapButton.y),ctx.globalAlpha=1}handleMousePress(t){if(window.inventory&&window.inventory.artifactContainer){const e=t.x/window.innerWidth*canvas.w,n=t.y/window.innerHeight*canvas.h,i=window.inventory.artifactSlot,a=i.y+window.inventory.translateY,s=i.size/2;if(e>i.x-s-20&&e<i.x+s+20&&n>a-s-20&&n<a+s+20){const t=window.inventory.artifactContainer.type;send({activateArtifactUltimate:{artifactType:t}})}}if(this.chatOpen&&document.activeElement===chatInput){const e=chatInput.getBoundingClientRect();if(t.x<e.left||t.x>e.right||t.y<e.top||t.y>e.bottom)return this.chatOpen=!1,chatInput.value="",chatInput.blur(),void(chatInput.style.opacity="0")}const e=t.x/window.innerWidth*canvas.w,n=t.y/window.innerHeight*canvas.h;if(window.dynamicJoystick){const t=n>=canvas.h-70;(e<canvas.w/2||e>=.7*canvas.w&&n>=canvas.h-.3*canvas.w)&&!(this.inCircleBounds(e,n,this.attackButton)||this.inCircleBounds(e,n,this.defendButton)||this.inCircleBounds(e,n,this.plusButton)||this.inCircleBounds(e,n,this.minusButton)||this.inCircleBounds(e,n,this.swapButton))&&e<canvas.w/2&&!t&&(this.currentlyHolding=!0,this.dynamicJoystickActive=!0,this.dynamicJoystickCenter={x:e,y:n},this.dynamicJoystickpad={x:e,y:n,r:canvas.w/15})}else this.inCircleBounds(e,n,this.joystickpad)&&(this.currentlyHolding=!0);if(this.inCircleBounds(e,n,this.attackButton)&&(send(["a",!0]),this.attacking=!0),this.inCircleBounds(e,n,this.defendButton)&&(send(["d",!0]),this.defending=!0),this.inCircleBounds(e,n,this.plusButton)&&(fov*=1.2,fov<.2&&(fov=.2),fov>3&&(fov=3)),this.inCircleBounds(e,n,this.minusButton)&&(fov*=.8,fov<.2&&(fov=.2),fov>3&&(fov=3)),this.inCircleBounds(e,n,this.swapButton))for(let t=0;t<10;t++)inventory.swapPetals(t)}handleMouseMove(t){if(!1===this.currentlyHolding)return;const e=t.x/window.innerWidth*canvas.w,n=t.y/window.innerHeight*canvas.h;if(e>canvas.w/2)return;this.joystick={r:canvas.w/40,magnitude:0,angle:0};const i=window.dynamicJoystick&&this.dynamicJoystickActive?this.dynamicJoystickpad:this.joystickpad,a=.6*i.r,s=e-i.x,o=n-i.y,c=room.flowers[window.selfId];let u=Math.sqrt(o**2+s**2);if(u>=a?(this.joystick.magnitude=a,u=220):u<a/5?(this.joystick.magnitude=0,u=0):(this.joystick.magnitude=(u/a)**.9*a,u=(u/a)**.9*220),c.angle=Math.atan2(o,s),this.joystick.angle=c.angle,c.magnitude=u,2!=latestInput.length&&(latestInput=[0,0]),latestInput[0]=Math.round(1e3*c.angle)/1e3,latestInput[1]=Math.round(10*u)/10,!arrayEquals(latestInput,previousInput))if(time-lastSentInput>minimumInputTime)send(latestInput),previousInput=window.structuredClone(latestInput),lastSentInput=time;else{let t=lastSentInput,e=latestInput;setTimeout(()=>{t==lastSentInput&&(send(e),previousInput=window.structuredClone(e),lastSentInput=time)},minimumInputTime-(time-lastSentInput))}}releaseControls(t){const e=t.x/window.innerWidth*canvas.w;if(t.y,window.innerHeight,canvas.h,e<canvas.w/2&&(this.currentlyHolding=!1,2!=latestInput.length&&(latestInput=[0,0]),latestInput[0]=0,latestInput[1]=0,this.joystick.angle=0,this.joystick.magnitude=0,!arrayEquals(latestInput,previousInput)))if(time-lastSentInput>minimumInputTime)send(latestInput),previousInput=window.structuredClone(latestInput),lastSentInput=time;else{let t=lastSentInput,e=latestInput;setTimeout(()=>{t==lastSentInput&&(send(e),previousInput=window.structuredClone(e),lastSentInput=time)},minimumInputTime-(time-lastSentInput))}e>canvas.w/2&&(this.attacking&&(send(["a",!1]),this.attacking=!1),this.defending&&(send(["d",!1]),this.defending=!1))}inCircleBounds(t,e,n){return t<n.x+n.r&&t>n.x-n.r&&e<n.y+n.r&&e>n.y-n.r}}